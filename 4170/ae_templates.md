# Работа с AE шаблонами.

## Шаг 1. Установка Carrot AE Plugin.

**Carrot System Monitor** устанавливается на тех рабочих станциях, на которых установлен **After Effects** и которые предполагается использовать для экспорта шаблонов на **Carrot Server**.

Для установки **Carrot AE Plugin** необходимо выполнить следующее:

1. Скопируйте папку `AEGP` в директорию `C:/Program Files/Adobe/Common/Plug-ins/7.0/MediaCore`;
   <br/> ![AEGP path](..\images\image129.png)

2. Запустите **InitSettings** в папке `Carrot/Bin` от имени администратора.
   <br/> ![run admin](..\images\image54.png)

## Шаг 2. Настройка Carrot AE Plugin.

Для настройки **Carrot AE Plugin** необходимо выполнить следующее:

1.  Запустите **Carrot Server** `ServerWS.exe`.
2.  Убедитесь в том, что в настройках **Carrot Template Preview** указан адрес необходимого сервера и номер порта для получения трекинг данных.
3.  Плагин готов к работе.

## Шаг 3. Настройка AE проекта для Carrot.

### 3.1. Настройки композиции.

1. Запустите Adobe After Effects.
2. Откройте проект.
3. На панели **Project** откройте корневую композицию, которую хотите экспортировать.
   ![](..\images\workflow_AE\stage_01.png)

4. Выберите меню **Composition** > **Composition Settings...** или нажмите клавиши **CTRL**+**K**.
   ![](..\images\workflow_AE\stage_02.png)

5. Проверьте разрешение и частоту кадров композиции.
   ![](..\images\workflow_AE\stage_03.png)

   > Частота кадров композиции должна совпадать с частотой кадров видеотракта.
   >
   > Разрешение композиции должно совпадать с разрешением контейнера в схеме движка Carrot.
   > 
   > ![](..\images\workflow_AE\stage_04.png)

6. Удалите из проекта все неиспользуемые элементы. Для этого выберите **File** > **Dependencies** > **Remove Unused Footage**.
   ![](..\images\workflow_AE\stage_07.png)

### 3.2. Указание точек входа и выхода анимации.

![](..\images\image152.png)

Для того, чтобы Carrot распознал отрезки анимации, пользователю требуется выставить маркеры композиции. Композиция должна содержать минимум 3 маркера. Если в других композициях присутствуют какие-либо маркеры, то их следует удалить.

Для того, чтобы добавить маркера:

1. Переместите ползунок в начало композиции (или анимации) и поставьте первый маркер с помощью клавиши **Numpad «\*»** на цифровой клавиатуре или выберите **Layer** > **Markers** > **Add Marker**:
   ![](..\images\workflow_AE\stage_06.png)

2. Щелкните правой кнопкой мыши по добавленному маркеру и выберите **Settings...**
   ![](..\images\workflow_AE\stage_05.png)

3. В открывшемся окне измените комментарий маркера на `OUT`.

   ![](..\images\image9.png)

4. Переместите ползунок в середину композиции и поставьте следующий маркер.

   ![](..\images\image174.png)

5. Измените комментарий маркера на `IN`

   ![](..\images\image7.png)

   ![](..\images\image95.png)

6. Переместите ползунок в конец композиции и поставьте следующий маркер.

   ![](..\images\image177.png)

7. Измените комментарий маркера на `OUT`.

   ![](..\images\image9.png)

Расположение маркеров будет выглядеть следующим образом:

![](..\images\image17.png)

Здесь присутствуют два временных промежутка:

- `OUT` - `IN` (в движке именуется как `IN`)
- `IN` - `OUT` (в движке именуется как `OUT`)

Воспроизведение в движке этого шаблона будет выглядеть следующим образом:

- Шаблон не активен, графика не показывается.
- Шаблон активируется, проигрывается область между маркерами `OUT`-`IN`.
- Шаблон активен, графика остаётся на позиции маркера `IN` и именуется как `ACTIVE`.
- Шаблон деактивируется, проигрывается область между маркерами `IN`-`OUT`.

7. Сохраните проект.

### 3.3. Указание точек дополнительных анимаций.

Композиция также может содержать дополнительные анимации помимо стандартных для входа и выхода. Для них также следует добавить маркеры. Для этого:

1. Переместите ползунок в начало желаемой анимации и добавьте новый маркер.
2. Измените комментарий маркера.
3. Переместите ползунок в конец желаемой анимации и добавьте ещё один маркер.
4. Измените комментарий маркера на желаемый.

Пример:

![](..\images\image140.png)

Здесь присутствуют три временных промежутка:

- `OUT` - `IN` (в движке именуется как `IN`)
- `IN` - `ANIM` (в движке именуется как `ANIM`)
- `ANIM` - `OUT` (в движке именуется как `OUT`)

Область между маркерами с одинаковыми именами (в примере `ANIM`-`ANIM`) игнорируется в **Carrot Engine** и пропускается при воспроизведении.

### 3.4. Дополнительная информация и рекомендации.

#### Проект

- Каждый шаблон рекомендуется сохранять в свой отдельный проект **After Effects**.
  > При экспорте шаблона из **After Effects** информация о всех композициях и контенте в проекте (в том числе неиспользуемых) передаётся и обрабатывается движком Carrot.

#### Эффекты

Поддерживаемые эффекты из **After Effects** в **Carrot Engine** в режиме реального времени:

- _Blur & Sharpen_ - **Sharpen**
- _Generate_ - **Fill**
- _Generate_ - **Gradient Ramp**
- _Color Correction_ - **Tritone**
- _Color Correction_ - **Tint**
- _Color Correction_ - **Levels**
- _Color Correction_ - **Curves**
- _Expression Controls_ - **3D Point Control**
- _Expression Controls_ - **Angle Control**
- _Expression Controls_ - **Checkbox Control**
- _Expression Controls_ - **Color Control**
- _Expression Controls_ - **Point Control**
- _Expression Controls_ - **Slider Control**
- _Transition_ - _Wipes_ - **Linear Wipe**

#### Композиции и слои

- Ключи анимации должны располагаться по краям кадров.
  ![](..\images\workflow_AE\stage_08.png)
- Слои, отмеченные в композиции как `Guide Layer` следует скрыть или удалить перед экспортом.
- При использовании логики **IF ELSE** внутри выражений, для корректной обработки в **Carrot Engine**, структура должна выглядеть следующим образом:

  ![](..\images\workflow_AE\stage_09.png)

- Все выражения, которые не требуют обработки в реальном времени, рекомендуется конвертировать в ключи анимации перед экспортом.

Поддерживаемые типы слоев в композиции:

- **Null Layer**
- **Solid Layer**
- **Shape Layer**, конвертированные в кривые Безье (без операций с контурами)
- **Text Layer** (без эффектов аниматора)
- **Media Layer** (MP4, MOV, JPG, PNG, PSD и т.д.)
  > В целях оптимизации шаблона и проекта PSD/AI слои внутри композиции рекомендуется заменить на Solid Layer, либо на готовое изображение PNG или JPG.

Поддерживаемые операции со слоями:

- **Track Matte** (Подложки отслеживания)
- **Parent Link** к другому слою или его свойствам (Привязка)
- **Blending Modes** (Режимы наложения)
- **Masking** (Маски)
- **Expressions** (Выражения)

#### Маски

- Маска в режиме наложения `None` скрывает отображение слоя в **Carrot Engine**.
- Единичную маску в режиме `Intersect` следует поменять на `Add`.
- Свойство `Mask Feather` по умолчанию в **Carrot Engine** использует бикубический режим сэмплинга.

#### Текст

- **Carrot Engine** считывает свойства текста (шрифта, размер, цвет, интервалы и т.д.) по первому символу и применяет их на все остальные символы.
- **Carrot Engine** принудительно применяет для кернинга текста тип `Metrics`.
- Используемые сторонние шрифты рекомендуется устанавливать в систему в формате **OTF**.

#### 3D слои

- **Carrot Engine** считывает систему измерений из After Effects в миллиметрах, т.е. 1000px в **After Effects** = 1000mm в **Carrot Engine**.
- Для вращения слоя следует использовать свойство **Orientation**.

## Шаг 4. Экспорт шаблона из проекта AE.

### 4.1. Экспорт шаблона.

1. Выберите меню `Composition` - `Export Carrot Template`.

![](..\images\image42.png)

> Примечание: если этот пункт не активен, нажмите на раздел с композициями в нижней части интерфейса **After Effects**. 2. Появится окно **Template Preview**.

    ![](..\images\image30.png)

3. Откройте вкладку `Animation` в центральном разделе `Viewport`.

   ![](..\images\workflow_AE\stage_10.png)

4. В поле `Composition` выберите композицию, которая была экспортирована:
   ![](..\images\image151.png)

Благодаря маркерам здесь появились три стейта:

- `IN` (соответствует промежутку `OUT`-`IN`)
- `ANIM` (соответствует промежутку `IN`-`ANIM`)
- `OUT` (соответствует промежутку `ANIM`-`OUT`)

  ![](..\images\image140.png)

4. Проверьте правильность воспроизведения анимации:

   1. Нажмите на название стейта.
      ![](..\images\workflow_AE\stage_11.png)

   2. Дождитесь завершения проигрывания.

5. Нажмите кнопку `Save Template`.

   ![](..\images\image69.png)

6. В новом окне выберите директорию для сохранения шаблона.

7. В поле `Name` задайте название шаблона.

8. Нажмите на поле `Container`.

9. В появившемся окне выберите нужную схему движка и укажите соответствующий контейнер.

   ![](..\images\workflow_AE\stage_13.png)

10. Нажмите на кнопку **Save Template**.
11. Закройте **Template Preview**.

### 4.2. Создание переменных.

Текстовые или медиа слои могут выступать в качестве оперативно изменяемых параметров шаблона в **Carrot Web Playlist**:

![](..\images\image120.png)
![](..\images\image100.png)

1. Для назначения слоя в качестве переменной выполните следующее:

   1. Выберите требуемый слой
   2. Зажмите левую кнопку мыши и перетащите его в раздел **Variables**.

   ![](..\images\workflow_AE\stage_14.png)

   2. Выберите созданную переменную
   3. В поле `Name` введите желаемое имя переменной.

   ![](..\images\workflow_AE\stage_12.png) 4. В поле `Type` укажите необходимый тип переменной.

#### Создание текстовой переменной

![](..\images\workflow_AE\result_01.gif)
Для назначения текстового слоя в качестве переменной выполните следующее:

1. Раскройте слой и найдите свойство `Source Text`.
2. Зажмите левую кнопку мыши и перетащите его в раздел **Variables**.

   ![](..\images\image145.png)

   - В поле `Name` введите желаемое имя переменной.
   - В поле `Type` укажите тип `Text` или `RichText`.
     > В случае, если указан тип `RichText`, к содержимому поля `DefaultValue` добавится тег изначального цвета текста:
     > ![](..\images\image201.png)

   ```xml
    "<font color=\"#000000\">Text Sample</font>"
   ```

3. Настройте плавность линий, отображающих текст:
   1. Выберите текстовой слой.
      ![](..\images\image125.png)
   2. В разделе `Properties` измените параметр `StepCount` на желаемый:
      ![](..\images\image173.png)

   Примеры значений параметра `StepCount`:<br>
   `StepCount` = 1:<br>![](..\images\image89.png)<br>
   `StepCount` = 2:<br>![](..\images\image161.png)<br>
   `StepCount` = 4:<br>![](..\images\image107.png)<br>
>Примечание: чем больше значение параметра `StepCount`, тем больше потребляется ресурсов ГП на отрисовку текста.