# Работа с ПО Carrot

## Шаг 1. Инициализация и запуск модулей Carrot.

### 1.1. Инициализация компонентов Carrot.

Инициализация настроек `Init Settings` необходима для сопряжения подключаемой сборки, после инициализации **Carrot Launcher** использует данные запущенной версии Carrot.

1. Откроем папку `Carrot`, далее `Bin`.
2. В списке файлов находим `InitSettings.exe`.
3. Запускаем файл от имени администратора.
4. Сборка иниализирована.

![Workflow_Init Settings](..\images\3998\image_015.jpg "Workflow - Init Settings")

---

### 1.2. Запуск компонентов Carrot.

Для начала работы с **Carrot** достаточно запустить `четыре` модуля:

- **Carrot Server** - единое место хранения медиа-контента и баз данных.
- **Carrot Laucher** - модуль для запуска **Carrot Engine**. Используется для настройки и регистрации рабочих станций.
- **Carrot WebPlaylist** - единая система управления контентом для всех **Carrot Engine**.
- **Carrot System Monitor** - модуль для настройки и запуска **Carrot Engine**, а также для централизованного управления шаблонами и медиа контентом.

Разберём каждый из модулей отдельно.

---

### 1.3. Carrot Server.

Запуск модулей **Carrot** всегда начинается с **Carrot Server**, являясь единым местом хранения медиа и баз данных, модуль выполняет роль центра объединяющего все прочие модули.

**Carrot Server** запускается только на одной рабочей машине, на остальных данный модуль не требуется.

1. Запустите модуль **Carrot Server** на рабочей машине, которую планируете использовать как **Host**.

![Workflow_Carrot Server](..\images\3189\image_016.jpg "Workflow - Carrot Server")

2. Убедитесь, что все подключенные модули отображаются в списке подключений. В случае, если модуль не появился в списке, нажмите `Refresh` - **Carrot Server** войдёт в цикл и начнёт поиск модулей, после нахождения нажмите на кнопку ещё раз. Если данный способ не помог, проверьте правильность IP-адреса прописанного в модулях.

![Workflow_Carrot Server_Refresh](..\images\3189\image_017.jpg "Workflow - Carrot Server - Refresh")

---
---

## Шаг 2. Регистрация рабочей станции.

### 2.1. Launcher.

**Carrot Launcher** необходим для старта **Carrot Engine**. Он позволяет регистрировать и настраивать рабочие станции отдельно на каждом устройстве, где предполагается использование **Carrot Engine**.

1. Запустите приложение **Carrot Launcher** (`Launcher.exe`).
2. В окне `Tools` нажмите на кнопку `Workstation Registration`.
3. Перед вами открыто окно для регистрации и настройки рабочей станции.

### 2.2. Workstation Registration.

>Для `экспорта` и `импорта` готовых пресетов нажмите на `File` и соответствующий раздел.

![Workflow_Workstation Registration](..\images\3189\image_018.jpg "Workflow - Workstation Registration")

4. В поле `Name` введите название рабочей станции. По умолчанию модуль берёт название текущего устройства.

![Workflow_Workstation Registration_Name](..\images\3189\image_019.jpg "Workflow - Workstation Registration - Name")

5. В разделе `Inputs` нажмите на `+` , перед вами раскроется список с возможностями, которые можно использовать в качества входа. Рассмотрим отдельно каждый `Input`.
- `AJA Tracked Input` - используется с картами видеозахвата **AJA**.
- `BMD Input` - используется с картами видеозахвата **Blackmagic Design**.
  - `UseResourceThread` - параметр работает в ресурсном потоке (не в потоке рендера, тем самым снижает нагрузку на ЦП);
  - `Use Audio Input` - параметр позволяет забирать аудиопоток.
- `BMD Tracked Input` - используется с картами видеозахвата **Blackmagic Design** при использовании трекинговых данных.
  - `Use Audio Input` - параметр позволяет забирать аудиопоток.
- `Texture Input` - используется для вывода изображения или видеофайла на устройстве.
- `Tracking Data` - используется для вывода только трекинг данных.
  - `Wait` - параметр позволяющий использовать его в схемах, где синхранизация должна приходить извне.
- `UE Input` - изображение запущенной сцены UE c трекингом. 
- `WebSocket Stream Input` - используется для вывода видеосигнала или аудиосигнала с устройства подключённого к данной рабочей станции.
  - `Use GPU Encoder` - при включённом параметре принудительно использует `Encoder` графического процессора. Рекомендуется использовать при работе с **4К** изображением.

> - При работе со звуком в `BMD Input`, звук в `BMD Output` и `BMD Fill/Key Output` автоматически подключается.
> - При работе со звуком можно использовать максимум один выход, при использовании двух или более буфер рендера переполняется.
> - Требования к видео при работе со звуком:
>   - 16 канальный звук;
>   - моно - работает только 3 канал;
>   - стерео - работает корректно, рекомендуется использовать 48кГц.

![Workflow_Workstation Registration_Inputs](..\images\3998\image_020.jpg "Workflow - Workstation Registration - Inputs")

6. В разделе `Outputs` нажмите на `+` , перед вами раскроется список с возможностями, которые можно использовать в качества выхода. Рассмотрим отдельно каждый `Outputs`.
- `AJA Output` - вывод изображения на карту AJA.
- `Bmd Fill/Key Output` - вывод изображений `Fill` и `Key` на карту **Blackmagic Design, Decklink**.
- `Bmd Output` - вывод изображения на карту **Blackmagic Design, Decklink**.
  - `UseResourceThread` - параметр работает в ресурсном потоке (не в потоке рендера, тем самым снижает нагрузку на ЦП);
- `Screen Output` - вывод изображения на экран монитора.
- `WebSocket Stream Output` - вывод изображения с одной рабочей станции **Carrot** на другую по локальной сети.
  - `Use GPU Decoder` - при включённом параметре принудительно использует `Decoder` графического процессора, при выключенном параметре используется **3D**. Рекомендуется использовать при работе с **4К** изображением.
- `Stream Output` - вывод изображения на стриминговый сервис (*например: YouTube*).

![Workflow_Workstation Registration_Outputs](..\images\3998\image_021.jpg "Workflow - Workstation Registration - Outputs")

7. Выберите и настройте входы и выходы для рабочей станции.

![Workflow_Workstation Registration_Inputs&Outputs](..\images\3189\image_022.jpg "Workflow - Workstation Registration - Inputs&Outputs")

8. Нажмите `Register/Update` для регистрации рабочий станции в **Carrot**.
9. В появившемся окне нажмите `ОК`.

![Workflow_Workstation Registration_Register](..\images\3189\image_023.jpg "Workflow - Workstation Registration - Register")

10. Ваша рабочая станция зарегистрирована в **Carrot**.

![Workflow_Workstation Registration_Succesful](..\images\3189\image_024.jpg "Workflow - Workstation Registration - Succesful")

>При необходимости удалить рабочую станцию из базы данных **Carrot Server** нажмите `UnRegister`.

---
---

## Шаг 3. Создание схемы в Carrot Flowchart.

### 3.1. System Monitor. 

**Carrot System Monitor** - модуль для настройки и запуска **Carrot Engine**, а также для централизованного управления шаблонами и медиа контентом.

**Carrot Engine** производит обработку изображения в соответствии со схемой, составленной в **System Monitor**.

> Как создать движок и добавить в него рабочие станции?

1. Перейдите во вкладку `Engines`.
2. Добавьте новую директорию нажав на `Add Folder`, либо выберите уже существующую.
3. Нажмите кнопку `Add Engine`.
4. Введите название движка и нажмите `ОК`.
5. Нажмите кнопку `Add Workstation` и выберите рабочие станции, которые будут задействованы в схеме.

![Workflow_System Monitor_Engines](..\images\3189\image_025.gif "Workflow - System Monitor - Engines")

### 3.2. Carrot Flowchart. 

> Как настроить схему для работы с движком?

1. Нажмите `Edit Scheme` - откроется окно `Engine Flowchart`.
2. Добавьте ноды ввода перетаскиванием из раздела `Registered inputs`.
3. Добавьте одну ноду вывода перетаскиванием из раздела `Registered outputs`.
4. Кликнув ПКМ по пустому месту выберите тип добавляемой ноды.
5. Соедините ноды.
6. Сохраните составленную схему нажатием кнопки `Save`.

![Workflow_System Monitor_FlowChart](..\images\3189\image_026.gif "Workflow - System Monitor - FlowChart")

Подробнее с нодами можно ознакомиться ниже:

>`Container` - используется для проигрывания AE и UE шаблонов.
>
>`Keyer` - используется для замены заднего фона изображения на другое изображение.
> - Пин `Foreground` принимает изображение, задний фон которого необходимо заменить.
> - Пин `Background` принимает изображение, на которое будет заменен задний фон.
>
>`AR` - служит для добавление объектов дополненной реальности.
> - Пин `Foreground` принимает изображение объекта который необходимо наложить.
> - Пин `Background` принимает изображение заднего фона.
>
>`Luma` - это кеер, в котором процесс формирования альфа маски отсутствует, поскольку он её получает как внешний сигнал.
> - Пин `Foreground` принимает изображение .
> - Пин `Background` принимает изображение .
> - Пин `Luma` принимает изображение из текстуры, где чёрный вычитает `Foreground`.
>
>`Viewport` - служит для прямого наложения нескольких веток друг на друга.
>
>`Blur` - служит для размылевания изображения подаваемого сигнала.
>
>`Distortion` - ручное искажение входящего в ноду изображения по коэффициентам дисторсии.
>
>`Undistorted UE Source` - находит запущенный UE шаблон и отображает его изображение без дисторсии.
>
>`Undistort` - обратная дисторсия на основании данных, полученных от трекинга.
>
>`Resize` - изменение размера изображения.
>
>`Image Tracker` - отслеживание выбранной области кадра (например лица) и перемещение изображения входящего в эту ноду в найденную область.
>
>`Ticker` - выводит бегущую строку в **Carrot Engine**, данные для бегущей строки берутся из модуля **DataStream**.

Данные ноды могут изменять следующие характеристики:
- Положение относительно левого верхнего угла (параметры X, Y).
- Размер изображения на выходе (параметры Width, Height).

> **Примечание:** если рассматривать ноды в качестве слоёв, то на итоговом изображении слои накладываются друг поверх друга начиная от ноды ввода к ноде вывода.

---
---

## Шаг 4. Экспорт AE / UE шаблона в Carrot.

### Экспорт AE шаблона в Carrot.

Подробнее о работе с AE шаблонами вы можете ознакомиться по данной [ссылке](ae_templates.md).

### Экспорт UE шаблона в Carrot.

Подробнее о работе с UE шаблонами вы можете ознакомиться по данной [ссылке](ue_templates.md).

---
---

## Шаг 5. Подготовка плейлиста.

### 5.1. WebPlaylist.

**Carrot WebPlaylist** - единая система управления контентом для всех **Carrot Engine**. Данный компонент состоит из двух модулей:
- **WebPlaylist** - сервер веб-плейлиста.
- **WebPlaylistSettings** - настройка сервера веб-плейлиста.

Для активации плейлиста в браузере, достаточно запустить приложение `WebPlaylist.exe`.

Если сервер плейлиста запущен правильно, должно появиться следующее окно.

![Workflow_WebPlaylist](..\images\4062\image_006.jpg "Workflow - WebPlaylist")

### 5.2. Carrot Dashboard.

Для проигрывания экспортированных шаблонов необходимо создать плейлист, с которого будут отправляться команды на их проигрывание.

Для этого:

1. Запустите браузер на вашей рабочей станции. Для корректной работы рекомендуем использовать **Google Chrome**.
2. В поисковой строке введите IP-адрес и порт вашего сервера. По умолчанию порт `:8088`.
3. Перед вами открыто окно авторизации в **Carrot Dashboard**.

![Settings_Carrot WebPlaylist_Browser](..\images\3189\image_007.jpg "Carrot WebPlaylist Browser")

4. Введите логин и пароль.
5. Перед вами откроется пустой **Carrot Dashboard**.

![Settings_Carrot Dashboard](..\images\3189\image_027.jpg "Carrot Dashboard")

### 5.3. Создание плейлиста.

Создадим **Playlist** для управления шаблонами **AE** и **UE** в **Carrot**.

1. Нажмите на раздел `Editor`.

![Settings_Carrot Dashboard_Playlist](..\images\3189\image_028.jpg "Carrot Dashboard - Playlist")

2. Нажмите на кнопку `New`.
3. В появившемся окне введите название будущего плейлиста.

![Settings_Carrot Dashboard_Playlist](..\images\3189\image_029.jpg "Carrot Dashboard - Playlist")

4. Нажмите `ОК`.
5. Перед вами открылся плейлист.

![Settings_Carrot Dashboard_Playlist](..\images\3189\image_030.jpg "Carrot Dashboard - Playlist")

### 5.4. Функционал и возможности работы с плейлистами.

Раздел `Playlist`.

- В области названия плейлиста присутствует иконка в виде папки, нажмите на неё, чтобы открыть желаемый плейлист.

![Settings_Carrot Dashboard_Playlist](..\images\3189\image_031.jpg "Carrot Dashboard - Playlist")

#### 5.4.1. Force Load

В настройках **WebPlaylist Server** есть возможность включить отображение дополнительной кнопки `Force Load` (*по правому клику на выбранный эвент*).

![Carrot WebPlaylist_Force Load](..\images\4062\image_062.jpg "Carrot WebPlaylist - Force Load")

При нажатии на кнопку происходит принудительное повторное скачивание ассетов шаблона и эвента с сервера, даже если ассеты уже были загружены локально.

![Carrot WebPlaylist_Force Load](..\images\4062\image_063.jpg "Carrot WebPlaylist - Force Load")

Данная функция необходима для случаев, когда локальный файл оказался испорчен.

Если же файл испорчен уже на сервере, то его перезапись происходит при пересохранении шаблона в **TemplatePreview**, либо при перезаливе ассетов во вкладке `Browser`-`Media` в вэбе.

---

Раздел `Editor`.

- Кнопка `New` - создать новый плейлист.
- Кнопка `Open` - открыть существующий плейлист.

---

Раздел `Browser`.

- Перейдём в раздел `Playlists`. 
- Кнопка `Add Playlist` создрать новый плейлист.
- Кнопка `+` создаёт новую директорию, где можно хранить плейлисты.
- Кнопка `All Playlists` раскрывает список с возможностью отображения созданных плейлистов.
  - `All Playlists` - показать все плейлисты подключенные к серверу.
  - `Ready Playlists` - показать все плейлисты подгруженные на сервере.
  - `Active Playlists` - показать все активные плейлисты на сервере.

> Отображение списка важная функция позволяющая отслеживать рабочие плейлисты, тем самым отключая их для снижения нагрузки на рабочую станцию.

---

Раздел `System Monitor`.

В настройках **WebPlaylist Server** необходимо поставить параметр `Enable System Monitor Page` в положение `True`.

Для отображения имени CarrotServer его также необходимо указать в настройках CarrotServer (поле Server Name)

![Carrot WebPlaylist_System Monitor](..\images\4062\image_064.jpg "Carrot WebPlaylist - System Monitor")

Сама страница содержит две вкладки:
- Media Servers - информация о машинах, где запущены Carrot Server
- Render Stations - информация о машинах, где запущены Carrot Engine

![Carrot WebPlaylist_System Monitor](..\images\4062\image_065.jpg "Carrot WebPlaylist - System Monitor")

- Регион `Hardware` - наличие/отсутсвие рейда, общяя заполненность дисков, оперативной памяти и загрузка ЦП.
- Регион `Network` - инфомация о сетевых картах.
- Регион `Storage` - более детальная информация о дисках в отдельности.
- Регион `Connected Applications` - информация о подключенных приложениях к **CarrotServer**, где в поле `Name` указан объект взаимодействия (*для **Carrot Engine** - имя схемы, для **Web Playlist** - имя открытого плейлиста, для **Template Preview** - имя открытого шаблона*)
- Регион `Connected Users` - отображение авторизованных подключений с указанием времени и адреса.

![Carrot WebPlaylist_System Monitor](..\images\4062\image_066.jpg "Carrot WebPlaylist - System Monitor")

Регион GPU - отображение информации о состянии видеокарты

Регион Carrot Engine - отображение информации о каждом запущенном на машине Carrot Engine. 
В регионе Carrot Engine указана версия ПО, тип лицензии, имя запущенной схемы, частота кадров, тип синхронизации, загрузка ЦП общая и по потокам (рендера, обработки ресурсов и скриптов) и составляющие времени кадра (сейчас указан только ProcessTime)

Также в Carrot Engine есть информация об устройствах ввода и вывода, используемых в схемах (имя, тип и размеры буферов (реальный/выставленный в настройках))

Если серверы находятся в режиме репликации, это тоже будет отображено.

![Carrot WebPlaylist_System Monitor](..\images\4062\image_067.jpg "Carrot WebPlaylist - System Monitor")

---

### 5.5. Работа с контентом в плейлисте.

>Для добавления контента в плейлист нужно выполнить следующие действия:

1. Откройте раздел `Editor`.
2. В области `Templates` выберите нужный шаблон.
3. Перетащите шаблон из области `Templates` в область событий.

![Settings_Carrot Dashboard_Content](..\images\3189\image_032.jpg "Carrot Dashboard - Content")

4. Если шаблон имеет больше нескольких стейтов, то для упрощения переноса рекомедуется использовать функцию `Generate Events`, для её вызова нужно нажать `ПКМ` на шаблон и выбрать данную кнопку.

![Settings_Carrot Dashboard_Content](..\images\3998\image_054.jpg "Carrot Dashboard - Content")

5. Если нажать на перенесённый шаблон, то в области `Properties` появятся редактируемые настройки данного шаблона.

![Settings_Carrot Dashboard_Content](..\images\3189\image_033.jpg "Carrot Dashboard - Content")

6. Раздел `Properties`:

- `Name` - имя редактируемого события.
- `Allow Runtime Changes` - возможность изменять шаблон пока он запущен.
- `State` - участок с которого будет воспроизводиться шаблон.
- `Pick Defaults` - возвращение стейта к изначальным настройкам.

Окно для указания `Media Inputs` в шаблоне:

- `Media Assets Library` - библиотека загруженных медиа файлов.
- `Inputs` - вход для видео потока (карта захвата, WebRTC, другие шаблоны).

7. Меню редактирования плейлиста.

- `Add store` - добавляет новую пустую историю в плейлист
- `Group` - группирует шаблоны в плейлисте
- `Rename story` - переименовывает выбранную историю
- `Remove item` - удаляет выбранный шаблон из истории
- `Remove story` - удаляет историю с находящимися внутри шаблонами
- `Dublicate Item` - дублировать выбранный шаблон.
- `Add Special Event` - добавить специальное событие в плейлист:
  - `Reset` - перезапустить движок (сброс задержек).
  - `Stop Playlist` - остановить события в плейлисте.
  - `Text Commands` - данное событие работает только с настройками кеера, экспортируйте настройки кеера в **XML** и внесите данные из файла в поле `Text Command`.

![Settings_Carrot Dashboard_Content](..\images\3189\image_034.jpg "Carrot Dashboard - Content")

>Для управления контентом в плейлисте нужно выполнить следующие действия:

- Перейдите в раздел `Playlist`.

![](..\images\image133.png)

- `Load` - загружает выбранное события в плейлисте.
- `Load all` - загружает все события в плейлисте.
- `In` - загружает и переводит активирует событие выбранное событие в плейлисте.
- `Next` - деактивирует выделенное событие в плейлисте и активирует нижестоящее событие.
- `Out` - деактивирует выделенное событие в плейлисте.
- `Unload` - выгружает выбранное события в плейлисте.
- `Unload all` - выгружает все события в плейлисте.

Выберите интересующий вас шаблон ЛКМ его фон станет серым, как показано на скриншоте:

![](..\images\image64.png)

Перед воспроизведением его надо загрузить в оперативную память это можно сделать кнопкой `Load` либо `ПРОБЕЛ` с клавиатуры (если вам нужно загрузить весь `Playlist` можно воспользоваться кнопкой `Load All`).

После того как шаблон был загружен цвет его текста станет чёрным, а `Status` изменится на `Ready`, как показано на скриншоте:

![](..\images\image29.png)

Теперь данный шаблон можно воспроизвести с помощью кнопки `IN` либо `ПРОБЕЛ` с клавиатуры, цвет строки станет зеленым, а `Status` измениться на `Active`, как показано на скриншоте:

![](..\images\image122.png)

Чтобы завершить воспроизведение (либо проиграть выходной стейт) нажмите клавишу `OUT`, как только воспроизведение закончиться `Status` измениться на `Ready` и зеленая подсветка отключится.

Если Вам необходимо перезалить шаблон с тем же именем файла, шаблон должен находиться в `Status Unloaded` перед загрузкой.

---

### 5.6. Добавление медиа файлов.

1. Перейдите во вкладку `Browser`. 
2. В разделе `Media` нажмите на `+`, чтобы создать директорию для будущего добавляемого медиа контента.
3. В созданной директории нажмите на Add Media, чтобы загрузить файл в браузер.

![Settings_Carrot Dashboard_Media](..\images\3189\image_035.jpg "Carrot Dashboard - Media")

---

### 5.7. Управление шаблонами.

1. Перейдите во вкладку `Browser`. 
2. В разделе `Templates` нажмите на `+`, чтобы создать директорию для структурирования будущих и текущих шаблонов.
3. Область с шаблонами представляет из себя список из `Templates` и их контента, здесь можно изменить текущий контейнер нажатием на пункт `Content`. Список предложит доступные для данной рабочей станции контейнеры с загруженным контентом.

![Settings_Carrot Dashboard_Templates](..\images\3189\image_036.jpg "Carrot Dashboard - Templates")

---
---

## Шаг 6. Запуск и настройка движка.

### 6.1. Carrot Engine. Запуск.

После настройки **Launcher**, **Carrot Workflow**, **UE/AE templates**, **Carrot WebPlaylist** можно приступить к запуску **Carrot Engine**.

1. Откройте приложение System Monitor.
2. Перейдите во вкладку Launcher.

![Settings_Carrot System Monitor_Launcher](..\images\3189\image_037.jpg "Carrot System Monitor - Launcher")

3. Выберите ранее настроенный движок.

>- **Серый** - приложение Launcher не запущено.
>
>![Settings_Carrot System Monitor_Launcher](..\images\3189\image_038.jpg "Carrot System Monitor - Grey")
>
>- **Жёлтый** - движок готов к запуску.
>
>![Settings_Carrot System Monitor_Launcher](..\images\3189\image_039.jpg "Carrot System Monitor - Yellow")
>
>- **Синий** - движок выбран для запуска. Выбрать отдельный движок можно через сочетание `CTRL + ЛКМ`.
>
>![Settings_Carrot System Monitor_Launcher](..\images\3189\image_040.jpg "Carrot System Monitor - Blue")
>
>- **Зелёный** - движок запущен.
>
>![Settings_Carrot System Monitor_Launcher](..\images\3189\image_041.jpg "Carrot System Monitor - Green")

4. Запустите выбраный движок через кнопку `Start`. После успешного запуска откроется приложение **Carrot Engine**, а окно движка в **System Monitor** станет *зелёным* и будет выдавать статистику рабочей станции.

![Settings_Carrot Engine](..\images\3189\image_042.jpg "Carrot Engine")

### 6.2. Carrot Engine. Settings.

Рассмотрим подробнее меню навигации **Carrot Engine**.

- `File` - `Settings` - открывает настройки Launcher. Подробнее о данном пункте можно прочитать [здесь](https://carrotsoftware.github.io/docs/3189/#/settings?id=settings-1).
- `View` - `Full Screen` - открывает **viewport** на полный экран.
- `View` - `Scale To Fit` - растягивает **viewport** под размер окна.
- `Delays` - `Show Delays Form` - окно для настройки задержек. Где `Input Delay` - задержка входного сигнала, а `Tracking Delay` - задержка по трекингу. Правильная настройка задержек убирает "плавучий" эффект при работе с графикой.
- `Tools` - `Workstation Registration` - открывает окно Workstation Registration, подробнее о его настройке можно прочитать [здесь](https://carrotsoftware.github.io/docs/3189/#/workflow?id=_22-workstation-registration).
- `Tools` - `Dummy Output` - заглушка выставляемая вместого изображения выдаваемого **Carrot Engine**.

---
---

### 6.3. Carrot Engine. BMD Tracking Input.

