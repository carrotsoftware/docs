# Дополнительные возможности Carrot

## Перенос базы данных между устройствами

**MALPathRedactor** - утилита заменяет пути до ассетов в базе данных перед запуском сервера, чтобы последний не удалял записи об ассетах, файлы которых не смог найти. 

`Использовать при переносе базы данных с одного устройства на другое`

Алгоритм переноса базы данных:

1. Сделать резервную копию своей базы данных.
2. Взять папку **Carrot** с другой машины и заменить свою.
3. Запустить **MALPathRedactor**.
4. Через кнопку `Browse` выбрать путь до файла `mediaAssetLibrary.db` (*по умолчанию AppData\Local\Carrot\DB\mediaAssetLibray.db*).
5. В первом поле указать путь до `Digital Assets`, который был указан в настройках сервера на машине, с которой была взята база данных.
6. Во втором поле пишем путь до новой папки с `Digital Assets`.
7. Нажать кнопку `Apply`.

![MALPathRedactor](..\images\4062\image_069.png "MALPathRedactor")

## Работа с DataStream

### Settings - первоначальная настройка DataStream

>DataBase

- `Directory` - расположение базы данных Carrot.
- `DB autoreplication` -  автоматическая репликация (копирование) базы данных от Host-сервера.
- `Directory` - расположение папки с плагинами.

>Licence
- `Licence Key` - лицензионный ключ для открытия полного функционала Carrot.

>Network
- `Server Host` - имя или IP-адрес Host-сервера.
- `Secure` - используется, если предполагается шифрованное соединение.
- `Reserve Server Host` - имя или IP-адрес резервного сервера.

>Plugins
- `Stop plugin if error` - остановка плагина при возникновении ошибки.

>User
- `Auto Logon` - автоматическое подключение пользователя при запуске приложения.
- `User Name` - имя пользователя (подробнее о правах доступа в [параграфе ?.?](test.md))
- `Password` - пароль пользователя.

---
---

### Начало работы с DataStream

`DataStream` - инструмент предназначенный для быстрого редактирования переменных в плейлисте через **XML** или **XLSX** файлы.

---

#### Описание функций DataStream

Структура приложения представляет собой **три раздела**: `Tables`, `Plugins`, `Settings`.

Разделы `Tables` и `Plugins` имеют схожее построение регионов.

>Таблицы:
- Первый регион: Добавление / Удаление таблиц.
- - `Add Table` - добавить таблицу.
- - `Delete Table` - удалить таблицу.
- Второй регион: Правила выбранной таблицы.
- - `Table Name` - изменить название выбранной таблицы.
- - `Add Cell` - создать ячейку с переменной.
- - `Sort by` - сортировать по: дате создания, дате внесённых изменений, имени.
- - `Unlink Cells` - удалить все связи с плейлистом.
- - `Delete Cells` - удалить ячейку.
- Третий регион: Настройка выбранной ячейки таблицы.
- - `Remove Link` - удалить выбранную связь (*например: удаление изменения параметра внесённого текста в титре*).
- - `Update Cell` - внесение изменений в ячейку (*аналогично кнопке "Сохранить"*).
- - `Cell: Value` - значение переменной: текстовые и численные.
- - `Common: Changed` - дата изменения переменной.
- - `Common: Created` - дата создания переменной.
- - `Common: Name` - имя переменной.

>Плагины:
- Первый регион: Добавление / Удаление плагинов.
- - `Add Plugin` - добавить плагин.
- - `Delete Plugin` - удалить плагин.
- Второй регион: Правила выбранного плагина.
- - `Plugin Name` - изменить название выбранного плагина.
- - `Add Rule` - создать правило. 
- - `Delete Rule` - удалить правило.
- Третий регион: Настройка выбранного правила плагина.
- - `Edit Cells` - добавляет выбранные ячейки для взаимодействия с данным правилом.
- - `Generate cells` - доступно только для **XLSX-таблиц**, создаёт задействованные ячейки в таблице в `DataStream` - `Tables`.
- - `Update Rule` - внесение изменений в правило (*аналогично кнопке "Сохранить"*).
- - `Common: Changed` - дата изменения переменной.
- - `Common: Created` - дата создания переменной.
- - `Common: Name` - имя переменной.
- - `Rule: Enabled` - включить / выключить правило.
- Дополнительный раздел для XML-таблиц.
- - `XML Parser: Path` - местоположения файла с форматом **XML**. 
- - `XML Parser: Update Interval` - интервал проверки файла в секундах. 
- Дополнительный раздел для XLSX-таблиц.
- - `XLSX Parser: Excluder` - исключает выбранную ячейку или диапазон.
- - `XLSX Parser: Path` - местоположения файла с форматом **XLSX**. 
- - `XLSX Parser: Selector` - задаёт строгий диапазон или ячейку для внесения переменных.
- - `XLSX Parser: Sheet Name` - имя листа.
- - `XLSX Parser: Update Interval` - интервал проверки файла в секундах. 
- - `XLSX Parser: Update Type` - при использовании `ByTime` берёт интервал из параметра `Update Interval`, при использовании `ByChange` вносит изменения после каждого сохранения (*данная функция работает не стабильно, рекомендуем использовать параметр* `ByTime`). 

Рассмотрим **три** типа смены данных в переменных шаблона.

---
---

#### Первый тип "Локальный"

1. Перейдём в раздел `Tables`.
![](..\images\image57.png)
![DataStream_Tables_Tables](..\images\DataStream\image_002.jpg "Tables")

2. Нажимаем `Add Table` (*Если необходимо удалить созданную таблицу нажимаем* `Delete Table`).

![DataStream_Tables_Add Table](..\images\DataStream\image_003.jpg "Add Table")

3. Нами была создана таблица с названием по умолчанию "**New Table**". Для удобства работы с таблицами, мы можем переименовать её во втором регионе в разделе `Table Name`. Вводим название, нажимаем `Apply`.

![DataStream_Tables_Table Name](..\images\DataStream\image_004.jpg "Table Name")

4. Далее создаём ячейку через нажатие кнопки `Add Cell`. Одна ячейка хранит одну переменную. Создадим необходимое количество ячеек.

![DataStream_Tables_Add Cell](..\images\DataStream\image_005.jpg "Add Cell")

5. Были созданы ячейки с названием по умолчанию "**NewCell**", для удобства использования переименуем ячейки под конкретные параметры. Для этого в третьем регионе в разделе `Common: Name` удалим старое название и напишем новое. После нажмём на `Update Cell`, чтобы сохранить изменения.

![DataStream_Tables_Common: Name](..\images\DataStream\image_006.jpg "Common: Name")

6. В `After Effects` перейдём в `Export Carrot Template`. 

![DataStream_AE_Export Carrot Template](..\images\DataStream\image_007.jpg "Export Carrot Template")

7. Переносим нужные параметры в раздел переменные `Variables`. Даём название переменным. Сохраняем шаблон через кнопку `Save Template`.

![DataStream_AE_Variables](..\images\DataStream\image_008.gif "Variables")

8. Открываем `WebPlaylist`. Во вкладке `Editor`, выбираем необходимый параметр в шаблоне. Раскрываем меню, нажимаем `Browse`. Выбираем раздел `DataStream`. Перед нами раскрыт список с созданными ранее таблицами, выбираем необходимую. Далее выбираем созданную ранее ячейку. Данная переменная подключена к ячейке `DataStream`, теперь все значения автоматически переносятся из неё в `Playlist`.

![DataStream_WebPlaylist_WebPlaylist](..\images\DataStream\image_009.gif "WebPlaylist")

9. В `DataStream` в третьем регионе мы видим используемые шаблоны и переменные, которые к ним подключены. Поменяем значение в параметре `Cell: Value`. Нажимаем `Update Cell`. **Готово** значение добавленно в переменную в `Playlist`.

![DataStream_Tables_Value](..\images\DataStream\image_010.gif "Value")
![DataStream_Carrot_Result](..\images\DataStream\image_017.jpg "Result_Local")

10. Удалить ссылку на переменную можно несколькими способами:
    
    **Способ №1.** Открываем `Playlist`. Далее `Editor`. Выбираем нужный шаблон и переменную. В раскрывшемся меню нажимаем `Browse` - `DataStream` - Таблица (*с ячейкой*) - Ячейка (*подсвечена красным*) - `Unlink`.

    **Способ №2.** Открываем `DataStream`. Далее в третьем регионе выбираем нужный шаблон и переменную. Нажимаем `Remove Link` в правом верхнем углу.

    **Способ №3.** Выбираем ячейку и нажимаем `Unlink Cells`. Данный способ удаляем все связи в выбранной ячейке.

---
---

#### Второй тип "XML"

1. Аналогично первому типу, проделываем все шаги с [1 по 5](datastream.md#первый-тип-локальный). **Важно! При работе с XML плагином имена созданных ячеек не должны содержать пробелы.**

2. Перейдём в раздел `Plugins`. Добавим плагин через кнопку `Add Plugin`. В открывшемся окне нажимаем на `Set` и указываем путь к файлу. Плагин `XMLParser.dll` лежит в папке `Carrot` - `Bin`.

![DataStream_Plugins_Add Plugin](..\images\DataStream\image_011.gif "Add Plugin")

3. Добавим правило для данного плагина через кнопку `Add Rule`. Это необходимо, чтобы ячейки принимали значения с XML-файла. Данное правило будет работать только после перезапуска приложения `DataStream`. **ПРИМЕЧАНИЕ**: *Если после добавления правила в третьем регионе в разделе `PluginSettings` у вас не появились параметры - удалите плагин, перезапустите `DataStream` и снова добавьте его*.

![DataStream_Plugins_Add Rule](..\images\DataStream\image_012.jpg "Add Rule")

4. Создадим текстовый документ. Внесём в него переменные через "<>". Вводим значения или текст. Сохраняем заменив `.txt` на `.xml`.

![DataStream_Plugins_XML File](..\images\DataStream\image_013.jpg "XML Flie")

5. Чтобы активировать правило, необходимо выставить `Rule: Enabled` - `True`. В `PluginSettings` в `Path` указываем путь к в XML-файлу. В `Update Interval` частоту проверки файла. 

![DataStream_Plugins_Activate Rule](..\images\DataStream\image_014.jpg "Activate Rule")

6. Привяжем XML-файл к созданным ранее ячейкам. Для этого нажимаем `Edit Cells`. Выбираем таблицу. Переносим ячейки через `Add Chosen Table Cells`. Нажимаем `Apply`. Не забудем сохранить изменения через `Update Rule`.

![DataStream_Plugins_Edit Cells](..\images\DataStream\image_015.gif "Edit Cells")

7. Перейдём в `Tables`. Наши ячейки автоматически поменяли значения подставив их из XML-файла.

![DataStream_Plugins_Cells XML](..\images\DataStream\image_016.jpg "Cells XML")

8. Проделаем действия из "Первого типа" [пункт 8](datastream.md#первый-тип-локальный).

![DataStream_Carrot_Result_XML](..\images\DataStream\image_018.gif "Result_XML")

---
---

#### Третий тип "XLSX"

1. В отличии от 1-го и 2-го типа, работу с 3-м нужно начинать с настройки плагина. Аналогично XML-плагину добавим XLSX через `Add Plugin`. Путь к файлу в папке `Carrot` - `Bin` - `XLSXParserV2.dll`.

2. Подготовим таблицу для DataStream. 

![DataStream_XLSX_XLSX](..\images\DataStream\image_019.jpg "XLSX")

3. В `DataStream` добавим правило через `Add Rule` и перезапустим приложение.

4. Активируем плагин через `Rule: Enabled` - `True`. В `PluginSettings` в графе `Path` введём путь к XLSX таблице. В `Selector` указываем диапазон ячеек XLSX файла, которые будут использованы. В `Sheet Name` пропишем название листа с данными. 

![DataStream_Plugin_XLSX Activate](..\images\DataStream\image_020.jpg "XLSX Activate")

5. Аналогично первому типу, проделываем все шаги с [1 по 5](datastream.md#первый-тип-локальный). **Важно! При работе с XLSX плагином имена созданных ячеек должны соответствовать ячейке XLSX таблицы, например: B1, C6, AZ12.**

6. Перезапустим `DataStream`, ячейки автоматически подцепили значения из таблицы. Если мы будем хотим добавить новую ячейку в `Tables` и XLSX файле, то после каждого подцепа нужно перезапускать `DataStream`.

7. Ручное добавление ячеек может быть неудобным, если необходимо вставить большой массив данных. В данном случае можно использовать функцию `Generate cells`. 

![DataStream_Carrot_Result_XLSX](..\images\DataStream\image_021.gif "Result_XLSX")

---
---

### Полезная информация

#### DataStream - автоматизация проигрывания

`DataStream` имеет полезную функцию для автоматического проигрывания анимации с последующей заменой данных в переменной. Для его активации необходимо выполнить несколько простых действий при экспорте шаблона в `Carrot Template Preview`.

1. Перенесём переменные в раздел `Variables`.

2. В каждой перенесённой переменной выставим в графе `DataStream` - `Update Type` - `Call Back`.

3. `Update State` - выставим вариант проигрывания анимации после смены данных.

4. Экспортируем шаблон.

![DataStream_Call Back](..\images\DataStream\image_022.gif "Call Back")

---
---

## Работа с Template Preview

### Полезная информация

#### OverlapIndex в UE Template

Если у двух стейтов одного шаблона `Overlap Index` > 0 и они одинаковые, то первое событие при включении второго перейдет из состояния `Active` в состояние `Ready`.

Если у стейтов `Overlap Index` > 0 и они разные - включение второго события оставит первое не тронутым.

![TemplatePreview_OverlapIndex](..\images\4062\image_061.jpg "Template Preview - OverlapIndex")