# Работа с Unreal Engine.

В данном разделе можно ознакомиться с установкой **Unreal Engine**, а также обучиться созданию и настройке его проектов для взаимодействия с **Carrot**.

>Перед началом работы, необходимо произвести установку (инициализацию) и первоначальную настройку приложений **Carrot**.

---

## Работа с Unreal Engine 5

### Установка Epic Games Launcher

Для установки **Epic Games Launcher** необходимо:

1. ![1.1.](..\images\UnrealEngine\Установка%20EGL\1.1.jpg)

Перейти на сайт [`Epic Games Store`](https://store.epicgames.com/) и нажать на кнопку [`Загрузить/Download`](https://launcher-public-service-prod06.ol.epicgames.com/launcher/api/installer/download/EpicGamesLauncherInstaller.msi?trackingId=dc4b0d2024ff48528e324e6a3e5ba8cf) и дождаться завершения загрузки установщика.

2. После загрузки установщика **Epic Games Launcher** необходимо его запустить и провести процедуру инсталяции на локальную рабочую станцию.

3. ![1.2.](..\images\UnrealEngine\Установка%20EGL\1.2.jpg)

Запустить установленный **Epic Games Launcher** и авторизоваться (создать или войти в учётную запись) в нём.

>В случае, если не удаётся войти в учётную запись при нажатии на кнопку `Войти позже` в окне авторизации, установка **Unreal Engine** будет невозможна.

4. ![1.3.](..\images\UnrealEngine\Установка%20EGL\1.3.jpg)

С целью скрытия информации некасающейся работы с **Unreal Engine 5**, следует соблюсти следующие действия:

- перейти в раздел **"Параметры"**;
- включить параметры **"Скрыть игровую библиотеку"** и **"Запустить при включении компьютера"**;
- отключить параметры **"Отображать игровые уведомления"** и **"Показывать уведомления о новостях и специальных предложениях"**.

![1.4.](..\images\UnrealEngine\Установка%20EGL\1.4.jpg)

---

### Установка Unreal Engine 5

Для установки **Unreal Engine 5** необходимо:

1. ![2.1.](..\images\UnrealEngine\Установка%20UE5\2.1.jpg)

Открыть **Epic Games Launcher**, перейти в раздел **Unreal Engine** и нажать на вкладку **"Библиотека"**.

2. ![2.2.](..\images\UnrealEngine\Установка%20UE5\2.2.jpg)

Нажать кнопку `+` и выпадающем списке выбрать необходимую версию **Unreal Engine**.

3. Нажать кнопку `Установить` и дождаться окончания инсталляции **Unreal Engine**.

>В случае установки **Unreal Engine** впервые, после нажатия кнопки `Установить` отобразится окно **Параметры установки**. С целью оптимизации процесса установки, следует отключить компоненты, не будут использоваться при работе с **Carrot**, а именно: `Android`, `IOS` и `Linux`
>![2.3.](..\images\UnrealEngine\Установка%20UE5\2.3.jpg)

---

### Создание проекта Unreal Engine 5

Для создания проекта в **Unreal Engine 5**, необходимо:

1. ![3.1.](..\images\UnrealEngine\Создание%20Проекта%20UE5\3.1.jpg)

Запустить установленный **Unreal Engine** с помощью соответствующей кнопки.

2. ![3.2.](..\images\UnrealEngine\Создание%20Проекта%20UE5\3.2.jpg)

После запуска **Unreal Engine** откроется окно **"Unreal Project Browser"**, в котором необходимо присвоить проекту имя и соблюсти следующие действия:
- нажать на вкладку `Games` (1);
- нажать на шаблон `Blank` (2);
- в свойствах проекта выбрать режим `BLUEPRINT` (проект без кода) (3);
- убрать галочку с параметра `Starter Content` (4);
- нажать кнопку `Create` (5).

---

### Установка Carrot Unreal Engine Plugin

Перед установкой **Carrot Unreal Engine Plugin** необходимо закрыть запущенный проект.

>Актуальные версии плагинов для **Unreal Engine**.
>
>|Наименование плагина|Поддерживаемая версия Unreal Engine|Примечание|
>|-------------------|----------|----------|
>|UEPlugin4.27_3.1.0_172|Unreal Engine 4.27|Отсутствует поддержка **Carrot Variables**. Строго указаны параметры камеры в ноде `Carrot Macro`.|
>|UEPlugin5.1_5.0_172.zip|Unreal Engine 5.1|Отсутствует поддержка **Carrot Variables**. Строго указаны параметры камеры в ноде `Carrot Macro`.|
>|UEPlugin5.2_5.0_172|Unreal Engine 5.2|Отсутствует поддержка **Carrot Variables**. Строго указаны параметры камеры в ноде `Carrot Macro`.|

Для установки **Carrot Unreal Engine Plugin** необходимо:

1. Открыть содержимое папки **Carrot Unreal Engine Plugin**.

2. ![4.1.](..\images\UnrealEngine\Установка%20Carrot%20UEP\4.1.jpg)

Скопировать папки **"Carrot"** и **"CarrotEditor"** в папку **Plugins** созданного проекта **Unreal Engine**.

>По умолчанию созданный проект **Unreal Engine** располагается в следующей директории: 
>`C:\Users\Имя_Пользователя\Documents\Unreal Projects\Наименование_Проекта\plugins`
>
>В случае, если папка с наименованием **"plugins"** отсутствует в директории с проектом, необходимо её **создать**.
>
>Информацию об используемой версии плагина можно узнать в файле **"Rev.txt"** из папок **"Carrot"** и **"CarrotEditor"**.

3. Запустить созданный проект **Unreal Engine**, открыть раздел **Edit** и перейти в окно **"Plugins"**;

4. ![4.2.](..\images\UnrealEngine\Установка%20Carrot%20UEP\4.2.jpg)

Найти установленные плагины **"Carrot"** и **"CarrotEditor"** путём ввода в поисковую строку **"сarrot"**, и убедиться в том, что они включены.

---

### Настройка проекта Unreal Engine 5

Перед настройкой проекта **Unreal Engine** необходимо закрыть запущенный проект и отредактировать файл **"DefaultEngine.ini"**.

>Файл **"DefaultEngine.ini"** по умолчанию располагается в директории созданного **Unreal Engine** проекта, а именно:  
>
>`C:\Users\Имя_Пользователя\Documents\Unreal Projects\Наименование_Проекта\Config\DefaultEngine.ini`

Для редактирования файла **"DefaultEngine.ini"** можно воспользоваться текстовым редактором и скопировать в него следующие команды:

```Текстовые команды
[/Script/Engine.Engine]
GameEngine=/Script/Carrot.CarrotGameEngine
GameViewportClientClassName=/Script/Carrot.CarrotViewportClient
CustomTimeStepClassName=/Script/Carrot.CarrotCustomTimeStep

[/Script/WindowsTargetPlatform.WindowsTargetSettings]
DefaultGraphicsRHI=DefaultGraphicsRHI_DX12
```
>В качестве текстовых редакторов могут использоваться встроенные приложения Windows, такие как: "Блокнот", "WordPad" и т.п.

Для настройки проекта **Unreal Engine** необходимо:

1. Открыть созданный проект **Unreal Engine**.

2. ![5.1.](..\images\UnrealEngine\Настройка%20Проекта%20Unreal%20Engine\5.1.jpg)

Открыть окно создания уровней с помощью сочетания клавиш `Ctrl + N`, выбрать `Empty Level` и нажать кнопку `Create`.

3. Сохранить созданный уровень с помощью сочетания клавиш `Ctrl + S`, откроется окно **Save Level As**, в котором в строке `Name` ввести наименование сохраняемого уровня (в примере указывается **MainScene**) и нажать кнопку `Save`.

4. В разделе `Edit` перейти в настройки `Editor Preferences`, в строку поиска ввести наименование параметра **"Use Less CPU when in Background"** и отключить его.

5. В разделе `Edit` перейти в настройки `Project Settings` и проверить (в случае необходимости настроить) используя поисковую строку следующие параметры в соответствии с таблицей ниже:

| Наименование параметра | Значение параметра     |
|------------------------|------------------------|
| Custom TimeStep        | `CarrotCustomTimeStep` |

>Значение `CarrotCustomTimeStep` параметра **Custom TimeStep** позволяет обеспечить покадровую синхронизацию **Carrot** c трекинг данными и видеосигналом проекта **Unreal Engine**. С данным значением, количество FPS при работе с проектом **Unreal Engine** будет низким до момента его отображения в **Carrot Engine** и запуска в режиме **Play Mode**. Для увеличения количества FPS, на **время работы** с проектом **Unreal Engine**, рекомендуется параметру **Custom TimeStep** присвоить значение `None`, но после окончания работ, необходимо обратно установить значение `CarrotCustomTimeStep` .

|                            |                                                |
|----------------------------|------------------------------------------------|
| Game Viewport Client Class | `CarrotViewportClient`                         |
| Editor Startup Map         | `MainScene (Наименование сохранённого уровня)` |
| Game Default Map           | `MainScene (Наименование сохранённого уровня)` |
| Frame Buffer Pixel Format  | `8bit RGBA`                                    |
| Anti-Aliasing Method       | `Temporal Anti-Aliasing (TAA)`                 |

>В случае присвоения параметру **Anti-Aliasing Method** значения **Temporal Super-Resolution (TSR)**, возможна некорректная обработка отдельных графических элементов при взаимодействии с **Carrot**. 

|                                                                |                            |
|----------------------------------------------------------------|----------------------------|
| Custom Depth-Stencil Pass                                      | `Enabled with Stencil`     |
| Enable alpha channel support in post processing (experimental) | `Allow through tonemapper` |

6. ![5.2.](..\images\UnrealEngine\Настройка%20Проекта%20Unreal%20Engine\5.2.jpg)

После настройки параметров и закрытия соответствующего окна, необходимо адаптировать рабочее пространство к отображению полного переченя рабочей информации, для этого в разделе `Window` добавить следующие окна представленные в таблице:

| Наименование окна | Назначение                                           |
|-------------------|------------------------------------------------------|
| `Outliner`        | Отображение всех используемых компонентов в проекте. |
| `Levels`          | Разграничение используемых компонентов по уровням.   |
| `Layers`          | Объединение компонентов в одну группу по слоям.      |

>В **Unreal Engine 5** имеется возможность включить интерфейс **Unreal Engine 4**, для этого необходимо перейти в раздел `Window`, выбрать `Load Layout` и **включить** параметр `UE4 Classic Layout`.

7. ![5.4.](..\images\UnrealEngine\Настройка%20Проекта%20Unreal%20Engine\5.4.jpg)

![5.3.](..\images\UnrealEngine\Настройка%20Проекта%20Unreal%20Engine\5.3.jpg)

В результате адаптации рабочего пространства, следует также настроить:

- в окне **Outliner** нажать на кнопку `⚙` и включить параметр `Only in Current Level`;
- открыть окно **Content Drawer/Content Browser**, нажать кнопку `⚙ Settings` и отключить все параметры в разделе **Content**, кроме `Show Plugin Content`.

---

### Подготовка проекта Unreal Engine для работы с Carrot

Для подготовки проекта **Unreal Engine** к работе с **Carrot** необходимо:

1. ![6.1.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.1.jpg)

![6.2.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.2.jpg)

![6.3.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.3.jpg)

Добавить с помощью кнопки `Quickly add to the project` на сцену главного уровня следующие компоненты представленные в таблице:

| Наименование раздела | Наименование компонента | Количество |
|----------------------|-------------------------|------------|
| **Basic**            | `Actor`                 | 3 шт.      |
| **Cinematic**        | `Cine Camera Actor`     | 1 шт.      |
| **Volumes**          | `Post Process Volume`   | 1 шт.      |

2. ![6.4.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.4.jpg)

В окне **Outliner** выделить все добавленные компоненты, перейти в окно **Details** и в разделе настроек `Transform` сбросить параметр `Location` с помощью кнопки `Reset`.

3. ![6.5.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.5.jpg)

Переименовать (c помощью клавиши `F2` при выделении компонента) и сгруппировать компоненты **CameraNull**, **CameraOffsets**, **CameraParent** и **CarrotCamera** путём их перемещения по следующей иерархической модели:

|Порядковый номер|Наименование компонента|Тип компонента|Назначение|
|-------------------|----------|----------|----------|
|1|**CameraNull**|`Actor`|Разграничение логики перемещения виртуальной камеры в проекте относительно других объектов. Используется для свободного перемещения камеры в пределах уровня.|
|2|**CameraOffsets**|`Actor`|Передача значений точек смещения (Offset: X, Y, Z. Rotation: Pan, Tilt, Roll) виртуальной камеры. Используется для точечного позиционирования в пределах уровня.|
|3|**CameraParent**|`Actor`|Приём значений точек смещения (Offset: X, Y, Z. Rotation: Pan, Tilt, Roll) камеры. Позволяет перемещать виртуальную камеру на основе полученных значений от трекинг системы камеры.|
|4|**CarrotCamera**|`CineCameraActor`|Приём технических характеристик камеры (фокусное расстояние, размер сенсора и т.п.). Позволяет присвоить принятые технические характеристики виртуальной камере.|

4. ![6.6.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.6.jpg)

Выбрать компонент **CarrotCamera**, перейти в окно **Details**, найти в разделе `Current Camera Settings` настройку `Lens Settings` и параметру `Min Focal Length` выставить значение `0.001mm`.

5. ![6.7.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.7.jpg)

![6.8.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.8.jpg)

Выбрать компонент **PostProcessVolume**, перейти в окно **Details**, перейти в раздел `Post Process Volume Settings` и включить настройку `Infinite Extent (Unbound)`, затем в разделе `Rendering Features` найти настройку `Post Process Materials` и **добавить** параметру `Array` **2 значения** с помощью кнопки `⊕`, а именно:

- **Значение № 1**: нажать `Choose`, выбрать `Asset reference` и присвоить используя поисковую строку значение `PostProcMat_Alpha`;

>Данное значение необходимо для реализации функционала работы **CustomStencil**.

- **Значение № 2**: нажать `Choose`, выбрать `Asset reference` и присвоить используя поисковую строку значение `PostProcMat_Frames`.

>Данное значение необходимо для синхронизации кадров между проектом **Unreal Engine** и **Carrot Engine**.

6. ![6.9.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.9.jpg)

С помощью элемента `List of world Blueprints available to the user for editing or creation` нажать на кнопку `Open Level Blueprint`.

>В результате проделанных действий откроется **система визуального программирования (Level Blueprint)**, где в окне **Event Graph** отобразятся следующие ноды (блоки распределения и обработки данных, действий, а также событий), представленные в таблице:
>
>![6.10.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.10.jpg)
>
>|Наименование ноды|Назначение|
>|-------------------|----------|
>|`Event BeginPlay`|Однократная активация события при запуске уровня.|
>|`Event Tick`|Покадровая активация события.|

7. ![6.11.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.11.jpg)

Из точки выхода ноды `Event BeginPlay` проложить связь (используя `левую кнопку мыши (ЛКМ)`) в свободное пространство окна **Level Blueprint**.

8. ![6.12.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.12.jpg)

В появившемся окне **Executable actions** с помощью поисковой строки найти ноду `Carrot Macro` и добавить её.

9. ![6.13.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.13.jpg)

Из проекта **Unreal Engine** переместить компоненты **CameraOffsets**, **CameraParent** и **CarrotCamera** в окно **Level Blueprint**, затем соединить все добавленные ноды с **Carrot Macro** в следующем порядке:
- ноду `Event Tick` с точкой входа `Event Tick`;
- ноду `CameraOffsets` с точкой входа `Tracking Offsets`;
- ноду `CameraParent` с точкой входа `Camera Parent`;
- ноду `CarrotCamera` с точкой входа `Cine Camera`;

10. ![6.14.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.14.jpg)

Из точки выхода `Command Loop` ноды `Carrot Macro` проложить связь в свободное пространство окна **Level Blueprint**, в открывшемся окне с помощью поисковой строки найти ноду `Switch on String`, затем соединить точку выхода `Command` ноды `Carrot Macro` с точкой входа `Selection` у ноды `Switch on String`.

11. ![6.15.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.15.jpg)

В ноде `Switch on String` с помощью команды `Add pin ⊕` создаём требуемое количество строк (ивентов). В качестве **примера** будут рассматриваться **5 строк (ивентов)**, представленные в таблице ниже.

|Наименование строки (ивента)|Назначение|
|-------------------|----------|
|`START`|"Пустой ивент". Используется для отображения уровня в Carrot Engine с объектива виртуальной камеры.|
|`SHOW`|Включение режима отображения графики.|
|`HIDE`|Отключение режима отображения графики.|
|`PLAY`|Воспроизведение анимации.|
|`RESET`|Сброс анимации.|

>**Переименовать** созданные строки (ивенты) можно в настройках `Pin Names` раздела `Pin Options` в окне **Details** (по умолчанию находится справа при выделении ноды). 
>
>**Во избежаение некорректной работы системы**, строку (ивент) `Default` следует **удалить**, путём нажатия на неё `правой кнопкой мыши (ПКМ)` и выбора команды `Remove Execution Pin`.
>
>Присвоенное строке имя, будет отображаться в Web Playlist (Carrot Dashboard) в качестве **ивента**.
>
>Созданная строка (ивент) в ноде **Switch on String** запускает созданный сценарий (используя другие ноды **Level Blueprint**) после себя, тем самым реализуя различный функционал, например: **воспроизведение и сброс анимации**, **включение режима отображения графики** и т.п.

12. **Нажать** кнопку `🖫` (`Save`) и **запустить** процесс компиляции с помощью соответствующей кнопки `Compile`.

>В случае, если после запуска процесса компиляции, отобразилось сообщение **ERROR!** у ноды `Carrot Macro`, необходимо убедиться в использовании **корректной** версии плагина (указаны в разделе **"Установка Carrot Unreal Engine Plugin"**).
>
> ![6.16.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.16.jpg)
> 
> Для исправления ошибки компиляции, необходимо нажать на точку входа `Settings` ноды **Carrot Macro** используя `правую кнопку мыши (ПКМ)`, выбрать `Split Struct Pin` и повторно запустить компиляцию с помощью кнопки `Compile`.
> 
>![6.17.](..\images\UnrealEngine\Подготовка%20Проекта%20UE\6.17.jpg)

13. Закрыть окно **Level Blueprint**.

---

### Создание RTT 

**Render Target Texture (RTT)** - представляет из себя текстуру, в которую возможна передача медиа в режиме реального времени.

>![7.1.](..\images\UnrealEngine\Создание%20RTT\7.1.jpg)
>
>**RTT** возможно применить к любому объекту и материалу. В телеиндустрии наиболее распространено использование **RTT** в качестве имитации **плазменных панелей**.

Для создаания **RTT** необходимо:

1. ![7.2.](..\images\UnrealEngine\Создание%20RTT\7.2.jpg)

Нажать в пустом месте окна **Content Drawer/Content Browser** `правую кнопку мыши (ПКМ)`, перейти в раздел `Texture` и выбрать объект `Render Target` задав ему имя (в качестве примера, используется имя объекта **RTT_01**).

>Количество используемых **Render Target** в проекте прямопропорционально планируемому количеству отображаемых изображений (видео-материалов). 

2. ![7.3.](..\images\UnrealEngine\Создание%20RTT\7.3.jpg)

**Открыть окно редактирования** созданного **RTT** объекта (**RTT_01**) используя двойное нажатие `левой кнопки мыши (ЛКМ)` на нём, перейти в окно **Details** и **присвоить** параметрам следующие значения представленные в таблице.

| Наименование параметра | Значение параметра |
|------------------------|--------------------|
| Min Gen Settings       | `NoMipmaps`        |
| Size X                 | `2048`             |
| Size Y                 | `2048`             |

>Значение параметров **Size X** и **Size Y** необходимо присваивать в соответствии с принимаемым разрешением сигнала.
>
>Пример: 
>- если планируется приём SDI сигнала с разрешением **1920х1080**, значение параметров **Size X** и **Size Y** необходимо выставить `1920` и `1080` соответственно;
>- если планируется приём шаблона After Effects c разрешением **2547х782**, значение параметров **Size X** и **Size Y** необходимо выставить `2547` и `782` соответственно.
>
>В случае присвоения некорректных значений параметрам **Size X** и **Size Y** возможен сбой отображения принимаемого сигнала. 

|                      |             |
|----------------------|-------------|
| Address X            | `Clamp`     |
| Address Y            | `Clamp`     |
| Render Target Format | `RTF RGBA8` |

3. **Нажать** кнопку `🖫` (`Save`) и закрыть **окно редактирования**.

>Перед использованием созданного **RTT** объекта (текстуры), необходимо создать **материал** в котором он будет задействоваться. В качестве примера, создадим материал имитирующий **плазменную панель** для этого необходимо:
>
>- нажать в пустом месте окна **Content Drawer/Content Browser** `правую кнопку мыши (ПКМ)`, перейти в раздел `Material` и выбрать `Material` задав ему имя (в примере используется **TV_01**);
>- перейти в окно **редактирования** двойным нажатием `левой кнопкой мыши (ЛКМ)` по созданному объекту (материалу);
>- создать ноду (используя `правую кнопки мыши (ПКМ)` при нажатии по пустому пространству окна **редактирования**) `Texture Sample`;
>- соединить точку выхода `RGB` ноды `Texture Sample` с точкой входа `Emissive Color` ноды материала `TV_01 (Используется в примере)`;
>- соединить точку выхода `А` ноды `Texture Sample` с точкой входа `Opacity` ноды материала `TV_01 (Используется в примере)`;
>- выбрать ноду `Texture Sample`, перейти в окно **Details**, в разделе `Material` параметру `Blend Mode` и `Shading Model` выбрать `Translucent` и `Unlit` соответственно, далее перейти в раздел `Material Expression Texture Base` и параметру `Texture` указать созданный ранее **RTT** (**RTT_01**). 
>- **нажать** кнопку `🖫` (`Save`) и закрыть **окно редактирования**
>
>![7.3.1.](..\images\UnrealEngine\Создание%20RTT\7.3.1.jpg)

4. ![7.4.](..\images\UnrealEngine\Создание%20RTT\7.4.png)

С помощью элемента `List of world Blueprints available to the user for editing or creation` открыть окно **Level Blueprint** путём нажатия на кнопку `Open Level Blueprint`.

>Далее рассматривается пример с учётом созданной ранее схемы  в **Level Blueprint** из раздела **Подготовка проекта Unreal Engine для работы с Carrot**

5. ![7.5.](..\images\UnrealEngine\Создание%20RTT\7.5.jpg)

Из точки выхода **Begin Play Out** ноды **Carrot Масrо** проложить связь (используя `левую кнопку мыши (ЛКМ)`) в свободное пространство окна **Level Blueprint**.

6. В появившемся окне **Executable actions** с помощью поисковой строки найти ноду `Carrot Reciever` и добавить её.

7. ![7.6.](..\images\UnrealEngine\Создание%20RTT\7.6.jpg)

В параметре `Texture Render Targer 2D` ноды `Carrot Reciever` выбрать созданный **RTT** (**RTT_01**), **запустить** процесс компиляции с помощью кнопки `Compile`, **нажать** кнопку `🖫` (`Save`) и закрыть окно **Level Blueprint**.

8. ![7.7.](..\images\UnrealEngine\Создание%20RTT\7.7.jpg)

Нажать на кнопку `Quickly add to the project`, перейти в раздел `Shapes` и добавить элемент `Plane (Плоскость)` напротив компонента **CarrotCamera**.

9. Открыть окно **Details** элемента `Plane` путём нажатия на него `левой кнопки мыши (ЛКМ)`, перейти в раздел `Materials` и параметру `Element 0` выбрать созданный **RTT** объект (**RTT_01**).

---

### Экспорт шаблона из проекта Unreal Engine 5

Экспорт шаблонов необходим для сохранения заготовленных проектов **Unreal Engine** в формате, позволяющему воспроизводить их Carrot Engine. Заготовленные шаблоны запускаются из Web Playlist (Carrot Dashboard).

>Перед экспортом шаблона необходимо запустить приложение `Carrot Server`.

![8.1.](..\images\UnrealEngine\Экспорт%20Шаблона%20UE\8.1.jpg)

Для экспорта шаблона из проекта **Unreal Engine** необходимо:

- нажать на кнопку **Export As Carrot Template** (1);

- в открывшемся окне **Template Preview** нажать кнопку `🖫` (`Save`) (2);

- откроется окно **Templates**, в котором необходимо присвоить имя экспортируемого шаблона в окне **Name** (в качестве примера, используется имя `MyProject`) и нажать на поле `Container` (3);

- в открывшемся окне выбрать **схему Carrot Engine** для запуска шаблонов **Unreal Engine** (4);

- отметить необходимый контейнер из списка доступных (5);

>В случае, если список доступных контейнеров отсутствует, необходимо убедиться в корректном составлении **схемы Carrot Engine** в приложении **Carrot** - **System Monitor**.

- нажать кнопку `ОК` (6);

- нажать кнопку `Save Template` в окне **Templates** (7).

---

### Создание ивентов Unreal Engine 5 в Web Playlist (Carrot Dashboard)

![9.1.](..\images\UnrealEngine\Создание%20Ивентов%20UE\9.1.jpg)

Для создания ивента **Unreal Engine** необходимо:

- открыть **окно "Editor"** (1);

- открыть **Template Manager** (2);

- выбрать экспортированный шаблон **Unreal Engine** `правой кнопкой мыши (ПКМ)` и нажать кнопку `Generate Events` (3);

- убедиться, что **Playlist** заполнился ивентами, указанными ранее в окне **Level Blueprint** у ноды **Switch on String** (`START`, `SHOW`, `HIDE`, `PLAY` и `RESET`) (4).

---

### Запуск ивента Unreal Engine 5

Для запуска ивента **Unreal Engine** через Web Playlist (Carrot Dashboard) необходимо:

![10.1.](..\images\UnrealEngine\Запуска%20Ивента%20UE\10.1.jpg)

1. Выбрать в **окне "Editor"** один из сгенерированных ивентов (в качестве примера используется ивент `START`).

2. Открыть **Event Properties**, нажать кнопку `≡` у созданного объекта **RTT** и в выпадающем списке выбрать `Browse`.

3. В открывшемся окне выбрать необходимый для отображения на объекте **RTT** медиа-файл (в примере используется файл формата `.png`).

4. Перед запуском ивента убедиться, что запущены и настроены все необходимые приложения Carrot (`Carrot Server`, `Web Playlist Server`, `Launcher` и `System Monitor`).

![10.2.](..\images\UnrealEngine\Запуска%20Ивента%20UE\10.2.jpg)

5. Открыть **окно "Playlist"**, выбрать с помощью `левой кнопкой мыши (ЛКМ)` необходимый для запуска ивент (в качестве примера выбран ивент `START`) и нажать клавишу `Пробел` на клавиатуре.

![10.3.](..\images\UnrealEngine\Запуска%20Ивента%20UE\10.3.jpg)

6. В окне **Carrot Engine** отобразится окончательный результат экспортированного проекта **Unreal Engine**.

---

### Создание и экспортирование переменных Carrot Variables

Одной из функциональных возможностей **Carrot** является изменение свойств объекта **Unreal Engine** при запущенном шаблоне (ивенте) в режиме реального времени. Для реализации данного функционала используются **Carrot Variables (переменные)**.

**Carrot Variables** включает в себя типы данных представленные в таблице ниже.

|Наименование переменной|Тип данных|Назначение|
|-------------------|----------|----------|
|`Carrot Get Boolean Variable`|Логический (Boolean).|Включение или отключение какого-либо события.|
|`Carrot Get Color Variable`|Число с плавающей точкой (Float)|Изменение цветовых значений по палитре **RGBA**. Пример: `R = 0,5`; `G = 0,5`; `B = 0,5`; `A = 1;`|
|`Carrot Get Text Variable`|Строковый (String).|Изменение тектовой информации.|
|`Carrot Get Float Variable`|Число с плавающей точкой (Float).|Изменение числового значения.|
|`Carrot Get Vector 2DVariable`|Число с плавающей точкой (Float).|Перемещение объекта в 2D пространстве по осям X, Y.|
|`Carrot Get Vector 3DVariable`|Число с плавающей точкой (Float).|Перемещение объекта в 3D пространстве по осям X, Y, Z.|

**Carrot Variables** доступны в системе визуального программирования (Level Blueprint).

>Перед использованием **Carrot Variables** необходимо убедиться, что установлен плагин **Carrot Unreal Engine Plugin**. Процесс установки плагина изложен в соответствующем [**разделе**](https://carrotsoftware.github.io/docs/0000/#/WorkUE5?id=%d0%a3%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-carrot-unreal-engine-plugin).

Для использования **Carrot Variables** необходимо:

![11.1.](..\images\UnrealEngine\Создание%20и%20Экспортирование%20Carrot%20Variables\11.1.jpg)

1. С помощью элемента `List of world Blueprints available to the user for editing or creation` нажать на кнопку `Open Level Blueprint`.

2. Создать типовую схему взаимодействия **Unreal Engine** с **Carrot** с использованием следующих нод `Event BeginPlay`, `Event Tick` и `Carrot Macro`.

>Процесс создания типовой схемы взаимодействия **Unreal Engine** с **Carrot** изложен в разделе [**"Подготовка проекта Unreal Engine для работы с Carrot"**](https://carrotsoftware.github.io/docs/0000/#/WorkUE5?id=%d0%9f%d0%be%d0%b4%d0%b3%d0%be%d1%82%d0%be%d0%b2%d0%ba%d0%b0-%d0%bf%d1%80%d0%be%d0%b5%d0%ba%d1%82%d0%b0-unreal-engine-%d0%b4%d0%bb%d1%8f-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b-%d1%81-carrot).

![11.2.](..\images\UnrealEngine\Создание%20и%20Экспортирование%20Carrot%20Variables\11.2.jpg)

3. Из точки выхода `Command` ноды `Carrot Macro` проложить связь в свободное пространство окна **Level Blueprint** и в открывшемся окне выбрать `Promote to variable`, затем соединить точку выхода `Command Loop` ноды `Carrot Macro` с точкой входа добавленной ноды `SET`.

>По результатам проделанных действий будет добавлена нода `SET` с переменной `Command`. В случае необходимости, при выделении ноды (используя `левую кнопку мыши (ЛКМ)`) обратившись к параметру `Variable Name` в разделе `Variable` окна **Details**, имеется возможность её переименования (в дальнейшем, в качестве примера будет использоваться переменная с наименованием `JSON Command`).

4. Аналогичным образом необходимо создать ноду `Sequence` из точки выхода `⏵` ноды `SET`, затем из точки выхода `Then 0` создать ноду `Switch on String` и из точки выхода `Then 1` создать одну из нод **Carrot Variables**, а затем создать другие из её точки выхода `Оutput Flow` в соответствии с рисунком.

>В качестве примера, в ноде `Switch on String` используется перечень строк (ивентов) из **шага 11** раздела [**"Подготовка проекта Unreal Engine для работы с Carrot"**](https://carrotsoftware.github.io/docs/0000/#/WorkUE5?id=%d0%9f%d0%be%d0%b4%d0%b3%d0%be%d1%82%d0%be%d0%b2%d0%ba%d0%b0-%d0%bf%d1%80%d0%be%d0%b5%d0%ba%d1%82%d0%b0-unreal-engine-%d0%b4%d0%bb%d1%8f-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b-%d1%81-carrot).
>
>Также, в качестве демонстрационного варианта в окне **Content Drawer/Content Browser** был заранее создан **классовый блупринт (Class Blueprint)** объекта `Actor` с наименованием `VariableTest`, который далее был добавлен в уровень (в качестве объекта `Actor`) и **Level Blueprint**. В том числе была добавлена функция с наименованием `Func Var Text`, включающая в себя перечень переменных (точек входа) **Unreal Engine** в соответствии с добавленными нодами **Carrot Variables** и соединённая . 
>
>Для удобства работы, рекомендуется добавить ноду, которая будет дублировать переменную `JSON Command (Используется в примере)` ноды `SET`. Для этого, в свободном пространстве окна **Level Blueprint** необходимо нажать `правую кнопку мыши (ПКМ)`, в открывшемся окне обратиться к поисковой строке, ввести `JSON Command (Используется в примере)` и выбрать ноду `Get JSON Command (Используется в примере)`. Далее добавленную ноду необходимо соединить с точкой входа `Command` добавленных нод **Carrot Variables**.

![11.3.](..\images\UnrealEngine\Создание%20и%20Экспортирование%20Carrot%20Variables\11.3.jpg)

5. После создания схемы в **Level Blueprint** с применением **Carrot Variables** необходимо:
- присвоить имя переменным в нодах **Carrot Variables** (1);

>Каждая нода **Carrot Variables** имеет точку входа `Variable Name`, которая содержит информацию об имени переменной (в дальнейшем используется в Web Playlist (Carrot Dashboard)). Изменение имени переменной происходит в соответствующем окне точки входа `Variable Name`.

- произвести экспорт созданных переменных с помощью кнопки **Export As Carrot Template** в основном рабочем пространстве (окне) **Unreal Engine** (2);
- в открывшемся окне **Template Preview** нажать кнопку `≡` окна **Variables** и добавить переменные (3);
- выбрать одну из добавленных переменных (в качестве примера используется переменная `Switch`), перейти в окно **Properties** и изменить в поле **Name** раздела **Variable** наименование переменной в соответствии с используемым наименованием точки входа `Variable Name` ноды **Carrot Variables** (4);
- нажать кнопку `🖫` (`Save`) и произвести экспорт шаблона (5).

>Ознакомиться с процессом экспорта шаблона можно в соответствующем [**разделе**](https://carrotsoftware.github.io/docs/0000/#/WorkUE5?id=%d0%ad%d0%ba%d1%81%d0%bf%d0%be%d1%80%d1%82-%d1%88%d0%b0%d0%b1%d0%bb%d0%be%d0%bd%d0%b0-%d0%b8%d0%b7-%d0%bf%d1%80%d0%be%d0%b5%d0%ba%d1%82%d0%b0-unreal-engine).

![11.4.](..\images\UnrealEngine\Создание%20и%20Экспортирование%20Carrot%20Variables\11.4.jpg)

6. В результате экспорта шаблона, необходимо открыть **Web Playlist (Carrot Dashboard)**, перейти в **окно Settings**, обратиться к разделу **Global settings** и включить параметр `Send non-saved active Event Changes to Engine`.

>Ознакомиться с назначением параметров **Web Playlist (Carrot Dashboard)** возможно в соответствующем [**разделе**](https://carrotsoftware.github.io/docs/0000/#/WebPlaylist?id=_5-%d0%9e%d0%ba%d0%bd%d0%be-quotsettingsquot).

7. Создать (в случае необходимости) ивент **Unreal Engine**.

>С процессом создания ивентов **Unreal Engine** в **Web Playlist (Carrot Dashboard)** можно ознакомиться в соответствующем [**разделе**](https://carrotsoftware.github.io/docs/0000/#/WorkUE5?id=%d0%a1%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d0%b8%d0%b2%d0%b5%d0%bd%d1%82%d0%be%d0%b2-unreal-engine-%d0%b2-web-playlist-carrot-dashboard).

![11.5.](..\images\UnrealEngine\Создание%20и%20Экспортирование%20Carrot%20Variables\11.5.jpg)

8. Открыть **окно Editor**, выбрать один из добавленных ивентов (в примере используется ивент с именем `SHOW`), включить режим редактирования переменных `Allow Runtime Change` в разделе **Event Properties**  и нажать кнопку `Apply`.

>Работа параметра `Send non-saved active Event Changes to Engine` осуществляется при включённом режиме редактирования переменных `Allow Runtime Change`.

9. В разделе **Event Properties** отобразится перечень **Carrot Variables**, позволяющих изменять свойства объекта при запущенном шаблоне (ивенте) с помощью их параметров.

>В случае изменения значений параметров **Carrot Variables**, необходимо нажать кнопку `Apply` для их применения на объекте.






## Работа с Unreal Engine 4

### Установка Carrot Unreal Engine Plugin.

**Carrot Unreal Engine Plugin** устанавливается на тех рабочих станциях, на которых установлен **Unreal Engine 4** и которые предполагается использовать для экспорта шаблонов на **Carrot Server**.

>Актуальные версии плагинов для **Unreal Engine**.
>
>|Наименование плагина|Поддерживаемая версия Unreal Engine|Примечание|
>|-------------------|----------|----------|
>|UEPlugin4.27_3.1.0_172|Unreal Engine 4.27|Отсутствует поддержка **Carrot Variables**. Строго указаны параметры камеры в ноде `Carrot Macro`|
>|UEPlugin5.1_5.0_172.zip|Unreal Engine 5.1|Отсутствует поддержка **Carrot Variables**. Строго указаны параметры камеры в ноде `Carrot Macro`|
>|UEPlugin5.2_5.0_172|Unreal Engine 5.2|Отсутствует поддержка **Carrot Variables**. Строго указаны параметры камеры в ноде `Carrot Macro`|

Для установки **Carrot Carrot Unreal Engine Plugin** необходимо выполнить следующее:

- Скопировать папку **CarrotEditor** в директорию `C:\Program Files\Epic Games\UE_4.26\Engine\Plugins\VirtualProduction`

![UE Plugin](..\images\image78.png)

---

### Установка Carrot Unreal Engine Plugin в проект

**Carrot Plugin** устанавливается в проект.

Для установки **Carrot Carrot Unreal Engine Plugin** в проект необходимо выполнить следующее:

1. Открыть содержимое папки **Carrot Unreal Engine Plugin**.

2. Скопировать папки **"Carrot"** и **"CarrotEditor"** в папку **Plugins** созданного проекта **Unreal Engine**.

>По умолчанию созданный проект **Unreal Engine** располагается в следующей директории: 
>`C:\Users\Имя_Пользователя\Documents\Unreal Projects\Наименование_Проекта\plugins`
>
>В случае, если папка с наименованием **"plugins"** отсутствует в директории с проектом, необходимо её **создать**.
>
>Информацию об используемой версии плагина можно узнать в файле **"Rev.txt"** из папок **"Carrot"** и **"CarrotEditor"**.

---

### Настройка Carrot Unreal Engine Plugin.

Для настройки **Carrot Unreal Engine Plugin** необходимо выполнить следующее:

1. В программе **Unreal Engine 4** открыть окно настройки `Plugins`

   ![](..\images\image115.jpg)

2. В общем списке выбрать `Carrot` и `CarrotEditor`

   ![](..\images\image10.png)

3. Перезапустить проект **UE**.

---

### Настройка Unreal Engine 4 проекта (новый плагин, цветная полоска).

Для подготовки проекта к экспорту шаблона необходимо выполнить следующее:

1. В дополнение к основным настройкам в проекте, в папке Config в файле DefaultEngine и в папке Windows в файле WindowsEngine необходимо добавить строки:

```text
[/Script/Engine.Engine]
GameEngine=/Script/Carrot.CarrotGameEngine
GameViewportClientClassName=/Script/Carrot.CarrotViewportClient
```

2. В разделе `Editor` - `General` - `Performance` выключите параметр `Use Less CPU when in Background`.

   ![](..\images\image183.png)

3. В разделе `Project` - `Engine` - `General Settings` в параметре `Game Viewport Client Class` выберите `CarrotViewportClient`.

   ![](..\images\image184.png)

4. Запустите проект, который необходимо экспортировать, включите плагины `Carrot` и `CarrotEditor` и перезапустите проект:

   ![](..\images\image10.png)

5. В разделе `Project` - `Maps & Modes` - `Default Maps` в параметрах `Editor Startup Map` и `Game Default Map` укажите ту сцену, которую предполагается использовать.

   ![](..\images\image143.png)

6. В настройках проекта в разделе `Engine` - `General Settings` - `Framerate` укажите:

- в поле `Custom TimeStep` укажите `CarrotCustomTimeStep`

  ![](..\images\image79.png)

4. Если в проекте используются анимации

5. В разделе `Engine` - `Rendering` - `Default Settings` - `Anti-Aliasing Method` выбрать `TemporalAA`.

   ![](..\images\image141.png)

6. В настройках проекта в разделе `Engine` - `Rendering` - `Postprocessing` установите параметры, указанные ниже:

   ![](..\images\image169.png)

7. В настройках проекта в разделе `Engine` - `Rendering` - `Default Settings` установите параметр `Frame Buffer Pixel Format` равным `8bit RGBA`:

   ![](..\images\image186.png)

8. Добавьте в сцену `Empty Actor` - этот объект будет отвечать за смещения координат, получаемых от **Carrot Tracking Server**.

   ![](..\images\image126.png)

9. Добавьте в сцену `Cine Camera Actor` - этот объект будет выполнять роль виртуальной камеры

   ![](..\images\image53.png)

10. Сделайте `Empty Actor` родительским объектом по отношению к `Cine Camera Actor`

    ![](..\images\image32.png)

11. Откройте свойства `Cine Camera Actor` и в разделе `Current Camera Settings` - `Lens Settings` установите параметр `Min Focal Length` равным 0 мм.

    ![](..\images\image190.png)

12. Добавьте в сцену `Post Process Volume`

    ![](..\images\image189.png)

13. В `Post Process Volume` - `Rendering Features` добавьте элементы и укажите пути на ассеты `PostProcMat_Alpha` и `PostProcMat_Frames` которые былы скопированы с плагином `Carrot`.

    ![](..\images\image187.png)

14. Также активируйте параметр `Infinite Extent (Unbound)`.

    ![](..\images\image188.png)

15. Если планируется завести изображение внутрь проекта, то создайте еще одну `Render Target` - эта текстура будет использоваться для ввода изображения. Таких текстур может быть несколько.

    ![](..\images\image66.png)

16. Настройки данной текстуры приведите в соответствие с указанными ниже:

    ![](..\images\image59.png)

    > Примечание: разрешение текстуры должно быть квадратным и кратным степени двойки (например, 256х256, 512х512, 2048х2048), а также близким с разрешением вьюпорта, с которого будет забираться изображение (см. 4.3 Создание схемы работы Carrot Engine)
    >
    > ![](..\images\image111.png)
    >
    > Если четкости входящей текстуры недостаточно - поставить `NoMipmaps`. В остальных случаях следует выбирать `Sharpen`.

17. Создайте материал, который будет использовать созданную `Render Target`:

    ![](..\images\image24.png)

18. Откройте настройки материала и задайте ему созданную текстуру:

    ![](..\images\image21.png)

19. Примените созданный материал на объект, на котором планируется отображать входящее изображение:

    ![](..\images\image171.png)

20. Откройте `Level Blueprint` и добавьте `Carrot Macro`.

    ![](..\images\image52.png)

21. Во входных параметрах `Carrot Macro` укажите:

    ![](..\images\image194.png)

    - `Event BeginPlay`
    - `Event Tick`
    - Объект `Cine Camera Actor`, используемый в качестве виртуальной камеры.
    - Объект `Empty Actor`, который является родительским по отношению к `Cine Camera Actor`.

    К выводу макроса `Event Tick Out` (или `Begin Play Out` **при использовании нового типа синхронизации**) добавьте ноду `Carrot Receiver` и укажите в ней текстуру:

    ![](..\images\image203.png)

    Если используется несколько текстур, необходимо скопировать ноду `Carrot Receiver` столько раз, сколько будет использоваться таких текстур.

    ![](..\images\image202.png)

    Если подобные текстуры вообще не используются, необходимо исключить ноду `Carrot Receiver` из процесса:

    ![](..\images\image204.png)

22. Используйте выходные пины `Begin Play Out` и `Event Tick Out`, если ивенты `Begin Play` и `Event Tick` будут использоваться после `Carrot Macro`:

    ![](..\images\image194.png)

23. Если проигрывание шаблона проекта подразумевает использование команд, то:

    - Создайте ноду `Switch on String` и соедините её с Carrot Macro.
    - Каждый выходной пин ноды `Switch on String` будет соответствовать команде, которую можно будет отправлять с `Carrot Playlist`.

    ![](..\images\image196.png)

Соедините выходные пины ноды `Switch on String` с теми событиями, которые должны выполниться при вызове команды, чьё имя соответствует имени пина.

---

### Настройка Unreal Engine 4 проекта (старый плагин, бегающая белая полоска).

Для подготовки проекта к экспорту шаблона необходимо выполнить следующее:

1. Запустите проект, который необходимо экспортировать, включите плагины `Carrot` и `CarrotEditor` и перезапустите проект:

   ![](..\images\image10.png)

2. В разделе `Project` - `Maps & Modes` - `Default Maps` в параметрах `Editor Startup Map` и `Game Default Map` укажите ту сцену, которую предполагается использовать.

   ![](..\images\image143.png)

3. В настройках проекта в разделе `Engine` - `General Settings` - `Framerate` - `Custom TimeStep` укажите `CarrotCustomTimeStep`:

   ![](..\images\image79.png)

4. В разделе `Engine` - `Rendering` - `Default Settings` - `Anti-Aliasing Method` выбрать `TemporalAA`.

   ![](..\images\image141.png)

5. В настройках проекта в разделе `Engine` - `Rendering` - `Postprocessing` установите параметры, указанные ниже:

   ![](..\images\image169.png)

6. В настройках проекта в разделе `Engine` - `Rendering` - `Default Settings` установите параметр `Frame Buffer Pixel Format` равным `Float RGBA`:

   ![](..\images\image106.png)

7. Добавьте в сцену `Empty Actor` - этот объект будет отвечать за смещения координат, получаемых от **Carrot Tracking Server**.

   ![](..\images\image126.png)

8. Добавьте в сцену `Cine Camera Actor` - этот объект будет выполнять роль виртуальной камеры

   ![](..\images\image53.png)

9. Сделайте `Empty Actor` родительским объектом по отношению к `Cine Camera Actor`

   ![](..\images\image32.png)

10. Откройте свойства `Cine Camera Actor` и в разделе `Current Camera Settings` - `Lens Settings` установите параметр `Min Focal Length` равным 0 мм.

    ![](..\images\image76.png)

11. Выберите компонент `CameraComponent` и добавьте к нему компонент `SceneCaptureComponent2D`.

    ![](..\images\image86.png)

12. Создайте `Render Target` - эта текстура будет использоваться для вывода изображения.

    ![](..\images\image66.png)

13. Настройки данной текстуры приведите в соответствие с указанными ниже:

    ![](..\images\image178.png)

    > Примечание: разрешение текстуры должно совпадать с разрешением вьюпорта, на котором она будет проигрываться (см. 4.3 Создание схемы работы Carrot Engine)

14. Скопируйте ассет `PostProcMat_Frames.uasset`, `PostProcMat_Alpha.uasset` и `CarrotMacroLibrary.uasset` в папку проекта

    ![](..\images\image179.png)
    ![](..\images\image85.png)

15. Откройте настройки компонента `SceneCaptureComponent2D` объекта `Cine Camera Actor` и установите параметры:

    ![](..\images\image146.png)

    - `Texture Target` - выберите ту `Render Target`, которую Вы создали для вывода изображения.
    - `Primitive Render Mode` - выберите `Render Scene Primitives`.
    - `Capture Source` - `Final Color (LDR) in RGB`.
    - `Capture Every Frame` - отключено.
    - `Capture on Movement` - отключено.
    - `Always Persist Rendering State` - включено.
    - `Temporal AA` - включено.

      ![](..\images\image148.png)

16. В разделе `Post Process Volume` - `Rendering Features` добавьте элементы и укажите пути на ассеты `PostProcMat_Alpha` и `PostProcMat_Frames` которые былы скопированы с плагином `Carrot`.

    ![](..\images\image60.png)

17. Если планируется завести изображение внутрь проекта, то создайте еще одну `Render Target` - эта текстура будет использоваться для ввода изображения. Таких текстур может быть несколько.

    ![](..\images\image66.png)

18. Настройки данной текстуры приведите в соответствие с указанными ниже:

    ![](..\images\image59.png)

    > Примечание: разрешение текстуры должно квадратным и кратным степени двойки (например, 256х256, 512х512, 2048х2048), а также близким с разрешением вьюпорта, с которого будет забираться изображение (см. 4.3 Создание схемы работы Carrot Engine)
    >
    > ![](..\images\image111.png)
    >
    > Если четкости входящей текстуры недостаточно - поставить `NoMipmaps`. В остальных случаях следует выбирать `Sharpen`.

19. Создайте материал, который будет использовать созданную `Render Target`:

    ![](..\images\image24.png)

20. Откройте настройки материала и задайте ему созданную текстуру:

    ![](..\images\image21.png)

21. Примените созданный материал на объект, на котором планируется отображать входящее изображение:

    ![](..\images\image171.png)

22. Откройте `Level Blueprint` и добавьте `Carrot Macro`.

    ![](..\images\image52.png)

23. Во входных параметрах `Carrot Macro` укажите:

    ![](..\images\image33.png)

    - `Event BeginPlay`
    - `Event Tick`
    - Объект `Cine Camera Actor`, используемый в качестве виртуальной камеры.
    - Объект `Empty Actor`, который является родительским по отношению к `Cine Camera Actor`.
    - `Input Render Target 2D` - указывается текстура, которая используется для ввода изображения.
    - `Output Render Target 2D` - указывается текстура, которая используется для вывода изображения.

    Если используется несколько текстур для входящих изображений, раскройте макрос:

    ![](..\images\image149.png)

    Необходимо скопировать ноду `Carrot Receiver` столько раз, сколько будет использоваться таких текстур.

    Причем первая текстура указывается в макросе, а последующие указываются в копиях ноды:

    ![](..\images\image101.png)

    Если подобные текстуры вообще не используются, необходимо исключить ноду `Carrot Receiver` из процесса:

    ![](..\images\image147.png)

24. Используйте выходные пины `Begin Play Out` и `Event Tick Out`, если ивенты `Begin Play` и `Event Tick` будут использоваться после `Carrot Macro`:

    ![](..\images\image33.png)

25. Если проигрывание шаблона проекта подразумевает использование команд, то:
    - Создайте ноду `Switch on String` и соедините её с Carrot Macro, как показано на рисунке выше.
    - Каждый выходной пин ноды `Switch on String` будет соответствовать команде, которую можно будет отправлять с `Carrot Playlist`.

Соедините выходные пины ноды `Switch on String` с теми событиями, которые должны выполниться при вызове команды, чьё имя соответствует имени пина.

26. В разделе `Editor` - `General` - `Performance` выключите параметр `Use Less CPU when in Background`.

    ![](..\images\image183.png)

---

### Экспорт шаблона из проекта Unreal Engine 4.

Для экспорта шаблона из проекта **Unreal Engine 4** необходимо выполнить следующее:

1. Нажмите кнопку `Export Carrot` (расположена на верхней панели):

   ![](..\images\image35.png)

2. Откроется окно `Carrot Objects`:

   ![](..\images\image160.png)

   В данном окне будут отображаться только те объекты проекта, которые будут использоваться для интеграции с **ПО Carrot**:

   - Текстуры для входных изображений;
   - Текстура выходного изображения;
   - Список команд.

3. Выберите режим сохранения шаблона:

   ![](..\images\image195.png)

   `Unreal Editor` - сохранится только шаблон проекта. Данный режим используется, когда запуск проекта происходит посредством `Unreal Editor`.
   `Already Packed Project` - указывается путь к уже собранному проекту. Происходит его упаковка и сохранение в **Carrot Server** вместе с шаблоном. Данный режим используется, когда нужен запуск собранного проекта.

4. Нажмите кнопку сохранения и выберите директорию сохранения:

   ![](..\images\image77.png)

5. В поле `Name` введите желаемое имя шаблона и нажмите `Save Template`.

6. Закройте окно `Carrot Objects`:

   ![](..\images\image88.png)

   > Примечание:
   >
   > - при запуске собранного проекта его окно должно быть развернуто;
   > - при запуске сцены из-под `UE Editor` окно сцены должно быть развернуто, а окно `UE Editor` должно быть свернуто.







