# Работа с ПО Carrot
## Работа с Carrot Server
### Изменение пароля администратора на Carrot Server

Для изменения пароля администратора выберите пункт `Tools` - `Change Administrator Password`:

![](_images/image124.png)

Откроется окно, в котором необходимо ввести новый пароль и нажать `Apply`:

![](_images/image162.png)

### Обновление списка подключений

Если известно, что подключение существует, но не отображается в списке подключений, то нажмите `Refresh` - программа войдет в цикл непрерывного обновления списка. Когда все подключения будут отображаться, нажмите `Refresh` еще раз.

![](_images/image23.png)

### Удаление подключенных к Carrot Server компонентов

В главной области окна **Carrot Server** отображаются текущие подключения:

![](_images/image90.png)

Для удаления подключения выделите его и нажмите `Disconnect Selected`:

![](_images/image4.png)

## Настройка и регистрация рабочей станции

Для работы компонента **Carrot Engine** на конкретной рабочей станции, необходимо провести её регистрацию в **Carrot Server**. Для этого:

1. Запустите **Carrot Launcher** и выберите пункт `Tools` - `Workstation Registration`:

![](_images/image167.png)

2. Откроется окно `Workstation Registration`:

![](_images/image154.png)

2. В поле `Name` введите желаемое имя рабочей станции.
3. В разделе `Inputs` добавьте ноды ввода:
    - Нажмите `+` и выберите тип ноды:
    
        ![](_images/image58.png)
        
        - `AjaTrackedInput` - работа с картой AJA при использовании UE4 шаблонов.
        - `Decklink10Bit` - работа с картой Decklink с глубиной цвета 10Bit.
        - `Decklink` - работа с картой Decklink с глубиной цвета 8Bit.
        - `RawRtc` - работа с подключением по WebRtc.
        - `BmdTrackedInput` - работа с картой Decklink при использовании UE4 шаблонов.
        - `TextureInput` - нода, использующая файл с изображением на компьютере.
        - `TrackedInput` - нода использующая только данные трекинга.
        - `WsStreamInput` - нода, для приёма сигнала с Carrot StreamSender.

    - Настройте параметры созданной ноды:

        ![](_images/image156.png)

        ![](_images/image28.png)

        ![](_images/image15.png)

        ![](_images/image82.png)

        ![](_images/image72.png)

4. В разделе `Outputs` добавьте ноды вывода:
    - Нажмите `+` и выберите тип ноды:

        ![](_images/image5.png)

        - `AjaOutput` - вывод изображения на карту AJA.
        - `Decklink` - вывод изображения на карту Decklink.
        - `DecklinkFillKey` - вывод изображений Fill и Key на карту Decklink.
        - `DecklinkSync` -
        - `Screen` - вывод изображения на экран монитора.
        - `WebStream` - вывод изображения на стриминговый сервис (например YouTube).

    - Настройте параметры созданной ноды:

        ![](_images/image182.png)
        
        ![](_images/image96.png)

        ![](_images/image114.png)

        ![](_images/image73.png)

        ![](_images/image55.png)

        ![](_images/image109.png)

5. Сохраните изменения:
    - Нажмите `Register/Update`:

        ![](_images/image75.png)

    - Выберите нужную директорию сохранения и нажмите `ОК`:

        ![](_images/image121.png)

    - Выберите нужную директорию сохранения и нажмите `ОК`:

        ![](_images/image155.png)

6. При необходимости удалить рабочую станцию из базы данных **Carrot Server** нажмите `UnRegister`:

    ![](_images/image75.png)

    Появится уведомление об успешном выполнении операции:

    ![](_images/image46.png)

## Создание схемы работы Carrot Engine

**Carrot Engine** производит обработку изображения в соответствии со схемой, составленной в `System Monitor`. Для этого:

1. Запустите `System Monitor` и выберите раздел `Engines`:

    ![](_images/image80.png)

2. Добавьте новую директорию нажав `Add Folder` либо выберите уже существующую.
3. Нажмите `Add Engine` и введите желаемое имя схемы и нажмите `OK`:

    ![](_images/image137.png)

4. Выберите созданную схему:

    ![](_images/image112.png)

5. Добавьте рабочие станции, которые будут работать по настраиваемой схеме:
    
    - Нажмите `Add Workstation` - откроется окно `Workstations`:

        ![](_images/image121.png)

    - Выберите рабочую станцию и нажмите `ОК`.
    - В разделе `Workstations` отобразится добавленная рабочая станция:

        ![](_images/image176.png)

6. Настройте созданную схему:
    - Нажмите `Edit Scheme` - откроется окно `Engine Flowchart`:

        ![](_images/image25.png)

    - Добавьте ноды ввода перетаскиванием из раздела `Registered inputs`:

        ![](_images/image26.png)

    - Добавьте одну ноду вывода перетаскиванием из раздела `Registered outputs`:

        ![](_images/image138.png)

    - Кликнув правой кнопкой мыши по пустому месту выберите тип добавляемой ноды:

        ![](_images/image103.png)

        - `Carrot Container` - используется для проигрывания шаблонов, либо для отображения изображения, получаемого от ноды ввода.

            ![](_images/image43.png)

            Данная нода может иметь несколько входных пинов. На вход можно подать как ноду ввода, так и другие ноды. Позволяет изменять следующие характеристики:
            - Положение относительно левого верхнего угла (параметры X, Y).
            - Размер изображения на выходе (параметры Width, Height).

        - `Carrot Keyer` - используется для замены заднего фона изображения на другое изображение.

            ![](_images/image81.png)

            Пин `Foreground` принимает изображение, задний фон которого необходимо заменить.
            
            Пин `Background` принимает изображение, на которое будет заменен задний фон.

            Позволяет изменять следующие характеристики:
            - Положение относительно левого верхнего угла (параметры X, Y).
            - Размер изображения на выходе (параметры Width, Height).

        - `Carrot AR` - Служит для добавление объектов дополненной реальности.

            Пин `Foreground` принимает изображение объекта который необходимо наложить.

            Пин `Background` принимает изображение заднего фона.

            Позволяет изменять следующие характеристики:
            - Положение относительно левого верхнего угла (параметры X, Y).
            - Размер изображения на выходе (параметры Width, Height).

        - `Carrot Viewport` - Случит для прямого наложения нескольких веток друг на друга.

    - Сохраните составленную схему нажатием кнопки `Save`.

        ![](_images/image139.png)

>Примечание: если рассматривать ноды в качестве слоёв, то на итоговом изображении слои накладываются друг поверх друга начиная от ноды ввода к ноде вывода.
>
>![](_images/image97.png)

## Настройка Carrot Keyer

### Настройка Mask

Зайдите `Carrot Keyer` -> `Key` -> `Alpha Mask` -> `Key color` -> `Pick` и выберите цвет который необходимо убрать.

![](_images/image166.png)

Нам необходимо убрать верхнюю часть кадра с оборудованием:

![](_images/image47.png)

- выберете в `Mode` -> `Alpha mask`

    В **Carrot Engine** включиться отображение `Alpha mask`.

- Перейдите в `Carrot Keyer` -> `Mask` -> `Scene` - > `Filename`

![](_images/image98.png)

И выберете модель вашей студии в формате `.fbx`

Модель должна содержать в себе следующие объекты:

1. Модель вашей циклорамы.
2. Модель помещения студии.
3. Захватчик отражений (если вы его используете).
4. Специальные объекты (при использовании excluder).

Они отобразятся в разделе `Objects`.

![](_images/image153.png)

Теперь каждому объекту надо указать его назначение.
Для этого щелкните по объекту `ЛКМ` и в разделе `ObjType` выберите его тип:

![](_images/image135.png)

В разделе `Object offsets` можно изменить местоположение угол поворота и размер объектов

Объекты вашей модели должны совпасть по положению с реальными результат должен выглядеть примерно так:

![](_images/image63.png)

Так же при статических камерах возможно использовать маски в формате `.png`

Для этого переключите `Mask type` -> `Texture`

И в разделе `Scene` -> `Filename` укажите путь к файлу:

![](_images/image98.png)

За тип маски в данном случае будет отвечать канал в пикселе изображения:

- Канал `Red` - Chromakey BG
- Канал `Blue` - VR BG
- Канал `Green` - Chromakey Floor

Результат работы масок:

![](_images/image74.png)

![](_images/image45.png)

## Подготовка AE проекта к экспорту шаблона
### Работа с композицией

Для подготовки AE проекта к экспорту шаблона на **Carrot Server** выполните следующее:

1. Откройте проект в AE:

![](_images/image152.png)

2. Выберите композицию, которую собираетесь экспортировать

![](_images/image168.png)

3. Композиция должна содержать минимум 3 маркера (`OUT` - `IN` - `OUT`), характеризующие начало (`OUT` - `IN`) и конец (`IN` - `OUT`) проигрываемой композиции. Для этого:

    1. Переместите ползунок в начало композиции и поставьте маркер:

        ![](_images/image1.png)

    2. Измените комментарий маркера на `OUT`

        ![](_images/image9.png)

    3. Переместите ползунок в середину композиции и поставьте маркер

        ![](_images/image174.png)

    4. Измените комментарий маркера на `IN`

        ![](_images/image7.png)

        ![](_images/image95.png)

    5. Переместите ползунок в конец композиции и поставьте маркер

        ![](_images/image177.png)

    6. Измените комментарий маркера на `OUT`.

        ![](_images/image9.png)

    7. Расположение маркеров будет выглядеть примерно так:

        ![](_images/image17.png)

    8. Если композиция содержит анимацию, которую необходимо проигрывать, следует создать для неё маркеры. Для этого:
        
        1. Переместите ползунок в начало анимации и поставьте маркер
        2. Измените комментарий маркера на желаемый
        3. Переместите ползунок в конец анимации и поставьте маркер
        4. Измените комментарий маркера на желаемый.
        >Примечание: если анимация начинается с начала композиции, то ее можно включить в маркеры `OUT`-`IN`, сместив `IN` на конец анимации.

        Пример:

        ![](_images/image140.png)

        Здесь присутствуют три временных промежутка: 
        - OUT-IN (в дальнейшем будет именоваться как стейт `IN`) 
        - IN-ANIM (в дальнейшем будет именоваться как стейт `ANIM`) 
        - ANIM-OUT (в дальнейшем будет именоваться как стейт `OUT`) 
        > Примечание: участки с одинаковыми маркерами (`ANIM`-`ANIM`) не учитываются.
4. Сохраните проект.

### Рекомендации к подготовке шаблона

На 27.04.2021 для корректной работы шаблонов представлены следующие рекомендации к подготовке проекта:

#### Основное
- Для каждого шаблона, имеющего свои таймкоды для маркеров стейтов, рекомендуется создавать свой отдельный проект.
- Для однотипных шаблонов с одинаковыми стейтами можно создать один проект с главной композицией с маркерами для экспорта, внутри которой пользователь вкладывает композиции других шаблонов и оставляет видимым необходимый для экспортирования в движок Carrot. Не смотря на то, что неиспользуемые композиции могут быть скрыты, информация о них все-равно передаётся и обрабатывается при экспорте шаблона.
- У композиций, кроме главной, не должно быть маркеров.
- Ключи анимации должны располагаться строго по краям кадров.

#### Эффекты
Список поддерживаемых эффектов на 27.04.2021:
- Generate - Fill
- Generate - Gradient Ramp
- Color Correction - Tritone
- Color Correction - Tint
- Color Correction - Levels
- Color Correction - Curves
- Blur & Sharpen - Sharpen
- Transition - Wipes - Linear Wipe

#### Структура проекта и композиции
- Shape Layer необходимо заменить на Solid Layer.
PSD, AI слои внутри композиции необходимо заменить на Solid Layer, либо на изображение PNG, JPG или другого подобного расширения.

Поддерживаемые типы слоев в композиции:
- Null Layer
- Solid Layer
- Text Layer
- Media Layer (MP4, MOV, JPG, PNG и т.д.)

Поддерживаемые механики в композиции:
- Track Matte
- Parent Link
- Blending Modes
- Masking
- Expressions

#### Маски
- Маски с режимом наложения None нужно изменить на другое. Если маска одна и в режиме Intersect  нужно поменять на Add.
- Свойство Mask Feather по умолчанию в движке Carrot использует режим сэмплинга Bicubic.

#### Текст
- Параметр Animator у текстового слоя не поддерживается.
- Свойства размера шрифта, цвет, интервалы и т.д. в текстовом слое считываются в движке Carrot только по первому элементу и применяются на весь слой.
- В движке Carrot для режима кернинга текстовых слоев используется тип Metrics.

#### Дополнительная информация
- Слои, отмеченные в композиции как Guide Layer рекомендуется скрыть или удалить перед экспортом в движок Carrot.
- Expression, в которых есть обращение к функции Time рекомендуется конвертировать в ключи.
- Все Expressions, которые не требуют вычисления в реальном времени или не зависят от параметров слоя, указанного в движке Carrot как переменная, рекомендуется предварительно конвертировать в ключи анимации.
- Для поворота 3D слоев рекомендуется использовать свойство Orientation.
- При использовании логики IF ELSE внутри Expression структура должна выглядеть следующим образом:

    `if (*условие*) {*выражение*} else {*выражение*};`

- Если у слоя имеются свойства Position, Rotation и Anchor Point с ключами анимации, то для того, чтобы менять их внутри Carrot Tracking Preview необходимо предварительно создать Null Layer и сделать его родителем этого слоя. Тогда взаимодействовать с его свойствами можно будет через созданный Null Layer.
- Если в шаблоне используется сторонний шрифт, то рекомендуется устанавливать его в систему в формате OTF.
- Слои кроме текстового по умолчанию в движке Carrot используют режим сэмплинга Bicubic.
- При работе с 3D шаблонами нужно учитывать, что в АЕ система измерений проходит в пикселях, эти значения движок Carrot использует как миллиметры.

## Экспорт шаблона из проекта AE

1. Выберите пункт `Composition` - `Export Carrot Template`.

![](_images/image42.png)

>Примечание: если этот пункт не активен, нажмите на раздел с композициями в нижней части интерфейса AE.
2. Появится окно экспорта шаблона **Template Preview**.

    ![](_images/image30.png)

3. Откройте вкладку `Animation` в центральном разделе `Viewport` и в поле `Composition` выберите композицию, на которой расставлены маркеры:

    ![](_images/image151.png)

    Здесь присутствуют три стейта:
    - `IN` (соответствует промежутку `OUT`-`IN`) 
    - `ANIM` (соответствует промежутку  `IN`-`ANIM`) 
    - `OUT` (соответствует промежутку `ANIM`-`OUT`)
4. Проверьте правильность анимации:
    - Нажмите на название стейта.
    - Дождитесь завершения проигрывания стейта.
5. Слои содержащие футажи или текст могут выступать в качестве изменяемых параметров шаблона:

    ![](_images/image120.png)
    ![](_images/image100.png)

    В **Template Preview** в разделе `Scene` слои отображаются так:

    ![](_images/image159.png)

6. Для назначения слоя, содержащего футаж, в качестве переменной, выполните следующее:
    - Зажмите левой кнопкой мыши этот слой и перетащите его в раздел `Variables`

    ![](_images/image134.png)

    - Выберите созданную переменную

    ![](_images/image87.png)

    - В поле `Name` введите желаемое имя переменной.
    - В поле `Type` укажите тип `File`.

7. Для назначения слоя, содержащего текст, в качестве переменной, выполните следующее:
    - Раскройте слой и найдите параметр Source Text.
    - Зажмите левой кнопкой мыши этот параметр и перетащите его в раздел Variables

    ![](_images/image145.png)

    - 

    ![](_images/image200.png)

    - В поле `Name` введите желаемое имя переменной.
    - В поле `Type` укажите тип `Text`. В случае, если указан тип `RichText`, к содержимому поля `DefaultValue` добавится тег черного цвета:

    ![](_images/image201.png)

        ```xml
        "<font color=\"#000000\">Text Sample</font>"
        ```

8. Настройте плавность линий, отображающих текст:
    - Выберите слой, содержащий текст

    ![](_images/image125.png)

    - В разделе `Properties` измените параметр `StepCount` на желаемый:

    ![](_images/image173.png)

    Примеры:

    - `StepCount` = 1:

    ![](_images/image89.png)

    - `StepCount` = 2:

    ![](_images/image161.png)

    - `StepCount` = 4:

    ![](_images/image107.png)

    >Примечание: чем больше значение `StepCount`, тем больше ресурсов тратится на отрисовку текста.

9. Нажмите кнопку сохранения

    ![](_images/image69.png)

10. Откроется окно выбора директории сохранения

    ![](_images/image119.png)

11. Выберите директорию и в поле `Name` введите желаемое имя шаблона.
12. Нажмите `Save Template`. По окончании сохранения данное окно закроется.
13. Закройте **Template Preview**.

## Подготовка UE4 проекта к экспорту шаблона (старый плагин)

Для подготовки проекта к экспорту шаблона необходимо выполнить следующее:

1. Запустите проект, который необходимо экспортировать, включите плагины `Carrot` и `CarrotEditor` и перезапустите проект:

    ![](_images/image10.png)

2. В разделе `Project` - `Maps & Modes` - `Default Maps` в параметрах `Editor Startup Map` и `Game Default Map` укажите ту сцену, которую предполагается использовать.

    ![](_images/image143.png)

3. В настройках проекта в разделе `Engine` - `General Settings` - `Framerate` - `Custom TimeStep` укажите `CarrotCustomTimeStep`:

    ![](_images/image79.png)

4. В разделе `Engine` - `Rendering` - `Default Settings` - `Anti-Aliasing Method` выбрать `TemporalAA`.

    ![](_images/image141.png)

5. В настройках проекта в разделе `Engine` - `Rendering` - `Postprocessing` установите параметры, указанные ниже:

    ![](_images/image169.png)

6. В настройках проекта в разделе `Engine` - `Rendering` - `Default Settings` установите параметр `Frame Buffer Pixel Format` равным `Float RGBA`:

    ![](_images/image106.png)

7. Добавьте в сцену `Empty Actor` - этот объект будет отвечать за смещения координат, получаемых от **Carrot Tracking Server**.

    ![](_images/image126.png)

8. Добавьте в сцену `Cine Camera Actor` - этот объект будет выполнять роль виртуальной камеры

    ![](_images/image53.png)

9. Сделайте `Empty Actor` родительским объектом по отношению к `Cine Camera Actor`

    ![](_images/image32.png)

10. Откройте свойства `Cine Camera Actor` и в разделе `Current Camera Settings` - `Lens Settings` установите параметр `Min Focal Length` равным 0 мм.

    ![](_images/image76.png)

11. Выберите компонент `CameraComponent` и добавьте к нему компонент `SceneCaptureComponent2D`.

    ![](_images/image86.png)

12. Создайте `Render Target` - эта текстура будет использоваться для вывода изображения.

    ![](_images/image66.png)

13. Настройки данной текстуры приведите в соответствие с указанными ниже:

    ![](_images/image178.png)

    >Примечание: разрешение текстуры должно совпадать с разрешением вьюпорта, на котором она будет проигрываться (см. 4.3 Создание схемы работы Carrot Engine)

14. Скопируйте ассет `PostProcMat_Frames.uasset`, `PostProcMat_Alpha.uasset` и `CarrotMacroLibrary.uasset` в папку проекта

    ![](_images/image179.png)
    ![](_images/image85.png)

15. Откройте настройки компонента `SceneCaptureComponent2D` объекта `Cine Camera Actor` и установите параметры:

    ![](_images/image146.png)

    - `Texture Target` - выберите ту `Render Target`, которую Вы создали для вывода изображения.
    - `Primitive Render Mode` - выберите `Render Scene Primitives`.
    - `Capture Source` - `Final Color (LDR) in RGB`.
    - `Capture Every Frame` - отключено.
    - `Capture on Movement` - отключено.
    - `Always Persist Rendering State` - включено.
    - `Temporal AA` - включено.

        ![](_images/image148.png)

16. В разделе `Post Process Volume` - `Rendering Features` добавьте элементы и укажите пути на ассеты `PostProcMat_Alpha` и `PostProcMat_Frames` которые былы скопированы с плагином `Carrot`.

    ![](_images/image60.png)

17. Если планируется завести изображение внутрь проекта, то создайте еще одну `Render Target` - эта текстура будет использоваться для ввода изображения. Таких текстур может быть несколько.

    ![](_images/image66.png)

18. Настройки данной текстуры приведите в соответствие с указанными ниже:

    ![](_images/image59.png)

    >Примечание: разрешение текстуры должно квадратным и кратным степени двойки (например, 256х256, 512х512, 2048х2048), а также близким с разрешением вьюпорта, с которого будет забираться изображение (см. 4.3 Создание схемы работы Carrot Engine)
    >
    >![](_images/image111.png)
    >
    >Если четкости входящей текстуры недостаточно - поставить `NoMipmaps`. В остальных случаях следует выбирать `Sharpen`.

19. Создайте материал, который будет использовать созданную `Render Target`:

    ![](_images/image24.png)

20. Откройте настройки материала и задайте ему созданную текстуру:

    ![](_images/image21.png)

21. Примените созданный материал на объект, на котором планируется отображать входящее изображение:

    ![](_images/image171.png)

22. Откройте `Level Blueprint` и добавьте `Carrot Macro`.

    ![](_images/image52.png)

23. Во входных параметрах `Carrot Macro` укажите:

    ![](_images/image33.png)

    - `Event BeginPlay`
    - `Event Tick`
    - Объект `Cine Camera Actor`, используемый в качестве виртуальной камеры.
    - Объект `Empty Actor`, который является родительским по отношению к `Cine Camera Actor`.
    - `Input Render Target 2D` - указывается текстура, которая используется для ввода изображения.
    - `Output Render Target 2D` - указывается текстура, которая используется для вывода изображения.
    
    Если используется несколько текстур для входящих изображений, раскройте макрос:

    ![](_images/image149.png)

    Необходимо скопировать ноду `Carrot Receiver` столько раз, сколько будет использоваться таких текстур.

    Причем первая текстура указывается в макросе, а последующие указываются в копиях ноды:

    ![](_images/image101.png)

    Если подобные текстуры вообще не используются, необходимо исключить ноду `Carrot Receiver` из процесса:

    ![](_images/image147.png)

24. Используйте выходные пины `Begin Play Out` и `Event Tick Out`, если ивенты `Begin Play` и `Event Tick` будут использоваться после `Carrot Macro`:

    ![](_images/image33.png)

25. Если проигрывание шаблона проекта подразумевает использование команд, то:
    - Создайте ноду `Switch on String` и соедините её с Carrot Macro, как показано на рисунке выше.
    - Каждый выходной пин ноды `Switch on String` будет соответствовать команде, которую можно будет отправлять с `Carrot Playlist`.

Соедините выходные пины ноды `Switch on String` с теми событиями, которые должны выполниться при вызове команды, чьё имя соответствует имени пина.

26. В разделе `Editor` - `General` - `Performance` выключите параметр `Use Less CPU when in Background`.

    ![](_images/image183.png)

## Подготовка UE4 проекта к экспорту шаблона (новый плагин)

Для подготовки проекта к экспорту шаблона необходимо выполнить следующее:

1. В дополнение к основным настройкам в проекте, в папке Config в файле DefaultEngine и в папке Windows в файле WindowsEngine необходимо добавить строки:

```text
[/Script/Engine.Engine]
GameEngine=/Script/Carrot.CarrotGameEngine
GameViewportClientClassName=/Script/Carrot.CarrotViewportClient
```

2. В разделе `Editor` - `General` - `Performance` выключите параметр `Use Less CPU when in Background`.

    ![](_images/image183.png)

3. В разделе `Project` - `Engine` - `General Settings` в параметре `Game Viewport Client Class`  выберите `CarrotViewportClient`.

    ![](_images/image184.png)

4. Запустите проект, который необходимо экспортировать, включите плагины `Carrot` и `CarrotEditor` и перезапустите проект:

    ![](_images/image10.png)

2. В разделе `Project` - `Maps & Modes` - `Default Maps` в параметрах `Editor Startup Map` и `Game Default Map` укажите ту сцену, которую предполагается использовать.

    ![](_images/image143.png)

3. В настройках проекта в разделе `Engine` - `General Settings` - `Framerate` укажите:
- поле `Smooth Frame Rate` сделайте активным
- в поле `Smoothed Frame Rate Range` укажите минимальный и максимальный пороги равными частоте кадров общего тракта. Свойство порогов должно быть `Inclusive`
- в поле `Min Desired Frame Rate` укажите частоту кадров общего тракта
- в поле `Custom TimeStep` укажите `CarrotCustomTimeStep`

    ![](_images/image197.png)

4. Если в проекте используются анимации

4. В разделе `Engine` - `Rendering` - `Default Settings` - `Anti-Aliasing Method` выбрать `TemporalAA`.

    ![](_images/image141.png)

5. В настройках проекта в разделе `Engine` - `Rendering` - `Postprocessing` установите параметры, указанные ниже:

    ![](_images/image169.png)

6. В настройках проекта в разделе `Engine` - `Rendering` - `Default Settings` установите параметр `Frame Buffer Pixel Format` равным `8bit RGBA`:

    ![](_images/image186.png)

7. Добавьте в сцену `Empty Actor` - этот объект будет отвечать за смещения координат, получаемых от **Carrot Tracking Server**.

    ![](_images/image126.png)

8. Добавьте в сцену `Cine Camera Actor` - этот объект будет выполнять роль виртуальной камеры

    ![](_images/image53.png)

9. Сделайте `Empty Actor` родительским объектом по отношению к `Cine Camera Actor`

    ![](_images/image32.png)

10. Откройте свойства `Cine Camera Actor` и в разделе `Current Camera Settings` - `Lens Settings` установите параметр `Min Focal Length` равным 0 мм.

    ![](_images/image190.png)

11. Добавьте в сцену `Post Process Volume`

    ![](_images/image189.png)

12. Скопируйте ассет `PostProcMat_Frames.uasset`, `PostProcMat_Alpha.uasset` и `CarrotMacroLibrary.uasset` в папку проекта

13. В `Post Process Volume` - `Rendering Features` добавьте элементы и укажите пути на ассеты `PostProcMat_Alpha` и `PostProcMat_Frames` которые былы скопированы с плагином `Carrot`.

    ![](_images/image187.png)

14. Также активируйте параметр `Infinite Extent (Unbound)`.

    ![](_images/image188.png)

15. Если планируется завести изображение внутрь проекта, то создайте еще одну `Render Target` - эта текстура будет использоваться для ввода изображения. Таких текстур может быть несколько.

    ![](_images/image66.png)

16. Настройки данной текстуры приведите в соответствие с указанными ниже:

    ![](_images/image59.png)

    >Примечание: разрешение текстуры должно быть квадратным и кратным степени двойки (например, 256х256, 512х512, 2048х2048), а также близким с разрешением вьюпорта, с которого будет забираться изображение (см. 4.3 Создание схемы работы Carrot Engine)
    >
    >![](_images/image111.png)
    >
    >Если четкости входящей текстуры недостаточно - поставить `NoMipmaps`. В остальных случаях следует выбирать `Sharpen`.

17. Создайте материал, который будет использовать созданную `Render Target`:

    ![](_images/image24.png)

18. Откройте настройки материала и задайте ему созданную текстуру:

    ![](_images/image21.png)

19. Примените созданный материал на объект, на котором планируется отображать входящее изображение:

    ![](_images/image171.png)

20. Откройте `Level Blueprint` и добавьте `Carrot Macro`.

    ![](_images/image52.png)

21. Во входных параметрах `Carrot Macro` укажите:

    ![](_images/image194.png)

    - `Event BeginPlay`
    - `Event Tick`
    - Объект `Cine Camera Actor`, используемый в качестве виртуальной камеры.
    - Объект `Empty Actor`, который является родительским по отношению к `Cine Camera Actor`.
    
    Внутри макроса добавьте ноду `Carrot Receiver` и кажите в ней текстуру:

    ![](_images/image192.png)

    Если используется несколько, необходимо скопировать ноду `Carrot Receiver` столько раз, сколько будет использоваться таких текстур.

    ![](_images/image193.png)

    Если подобные текстуры вообще не используются, необходимо исключить ноду `Carrot Receiver` из процесса:

    ![](_images/image191.png)

22. Используйте выходные пины `Begin Play Out` и `Event Tick Out`, если ивенты `Begin Play` и `Event Tick` будут использоваться после `Carrot Macro`:

    ![](_images/image194.png)

23. Если проигрывание шаблона проекта подразумевает использование команд, то:
    - Создайте ноду `Switch on String` и соедините её с Carrot Macro.
    - Каждый выходной пин ноды `Switch on String` будет соответствовать команде, которую можно будет отправлять с `Carrot Playlist`.

    ![](_images/image196.png)

Соедините выходные пины ноды `Switch on String` с теми событиями, которые должны выполниться при вызове команды, чьё имя соответствует имени пина.



## Экспорт шаблона из проекта UE4

Для экспорта шаблона из проекта UE4 необходимо выполнить следующее:

1. Нажмите кнопку `Export Carrot` (расположена на верхней панели):

    ![](_images/image35.png)

2. Откроется окно `Carrot Objects`:

    ![](_images/image160.png)

    В данном окне будут отображаться только те объекты проекта, которые будут использоваться для интеграции с **ПО Carrot**:

    - Текстуры для входных изображений;
    - Текстура выходного изображения;
    - Список команд.

3. Выберите режим сохранения шаблона:

    ![](_images/image195.png)

    `Unreal Editor` - сохранится только шаблон проекта. Данный режим используется, когда запуск проекта происходит посредством `Unreal Editor`.
    `Already Packed Project` - указывается путь к уже собранному проекту.  Происходит его упаковка и сохранение в **Carrot Server** вместе с шаблоном. Данный режим используется, когда нужен запуск собранного проекта.

4. Нажмите кнопку сохранения и выберите директорию сохранения:

    ![](_images/image77.png)

5. В поле `Name` введите желаемое имя шаблона и нажмите `Save Template`.

6. Закройте окно `Carrot Objects`:

    ![](_images/image88.png)

    > Примечание:
    >
    > - при запуске собранного проекта его окно должно быть развернуто;
    > - при запуске сцены из-под `UE Editor` окно сцены должно быть развернуто, а окно `UE Editor` должно быть свернуто.

## Создание плейлиста

Для проигрывания экспортированных шаблонов необходимо создать плейлист, с которого будут отправляться команды на их проигрывание.

Для этого:
1. Запустите `Carrot Web Playlist` зайдите через браузер на страницу управления плейлистами.
2. Выберите пункт `Editor`

    ![](_images/image44.png)

3. Нажмите кнопку `NEW`.
    Откроется вкладка создания нового плейлиста.

    В разделе `Enter Playlist Name` введите имя будущего плейлиста.

    Нажмите `OK`.

    ![](_images/image84.png)

4. Окно `Editor` состоит из трех областей
    - Область настройки плейлиста (выделена красным) служит для настройки очередности событий в плейлисте
    - Область `Templates` (выделена зеленым) тут хранятся загруженные на сервер шаблоны
    - Область `Properties` (выделена синим) служит для настройки поведения конкретного шаблона в плейлисте.

    ![](_images/image20.png)

5. Заполнение плейлиста:
    - Плейлист заполняет перетягиваем мышки (Drug and Drop) шаблона из области `Templates` в область плейлиста.

6. Меню редактирования плейлиста

    ![](_images/image56.png)

    - `Add store` - добавляет новую пустую историю в плейлист
    - `Group` - группирует шаблоны в плейлисте
    - `Rename story` - переименовывает выбранную историю
    - `Remove item` - удаляет выбранный шаблон из истории
    - `Remove story` - удаляет историю с находящимися внутри шаблонами

7. Раздел `Properties`

    ![](_images/image83.png)

    `Name` - имя шаблона которое будет отображаться в плейлисте.
    `Template name` - имя шаблона задается при сохранении на сервер.
    `State` - стейт с которого будет воспроизводиться шаблон.
    `Новость\Улица` - Текстовое параметрическое поле задается при создании шаблона.
    `Back\Face` - `Media input` для отображения в шаблоне медиаданных (фото, видео файлов а так же захват изображения с карты захвата)
    поля задаются при создании шаблона.

    Окно для указания `media inputs` в шаблоне:

    ![](_images/image50.png)

    - `Media Assets Library` - библиотека загруженных медиа файлов
    - `Inputs` - Вход для видео потока (Карта захвата, WebRTC, другие шаблоны)

## Проигрывание плейлиста

![](_images/image133.png)

- `Load` - загружает выбранное события в плейлисте.
- `Load all` - загружает все события в плейлисте.
- `In` - загружает и переводит активирует событие выбранное событие в плейлисте.
- `Next` - деактивирует выделенное событие в плейлисте и активирует нижестоящее событие.
- `Out` - деактивирует выделенное событие в плейлисте.
- `Unload` - выгружает выбранное события в плейлисте.
- `Unload all` - выгружает все события в плейлисте.

Выберите интересующий вас шаблон ЛКМ его фон станет серым, как показано на скриншоте:

![](_images/image64.png)

Перед воспроизведение его надо загрузить в оперативную память это можно сделать кнопкой `Load` либо `ПРОБЕЛ` с клавиатуры (если вам нужно загрузить весь `playlist` можно воспользоваться кнопкой `load all`).

После того как шаблон был загружен цвет его теста станет черным, а `Status` измениться на `Ready`, как показано на скриншоте:

![](_images/image29.png)

Теперь данный шаблон можно воспроизвести с помощью кнопки `IN` либо `ПРОБЕЛ` с клавиатуры, цвет строки станет зеленым, а `Status` измениться на `Active`, как показано на скриншоте:

![](_images/image122.png)

Чтобы завершить воспроизведение (либо проиграть выходной стейт)

нажмите клавишу `OUT`, как только воспроизведение закончиться  `Status` измениться на `Ready` и зеленая подсветка отключиться.

Шаблоны находящиеся в `Status Active` не подлежат редактированию!!!

Перед редактирование шаблона его обязательно надо перевести в `Status Ready`.

Если Вам необходимо перезалить шаблон с тем же именем файла, шаблон должен находиться в `Status Unloaded` перед загрузкой.

## Настройка задержек ввода/вывода

Для настройки задержек необходимо выполнить следующее:

Откройте меню `Carrot Engine` - `Delays` - `Show Delays Form`

![](_images/image16.png)

Откроется форма настройки задержек

![](_images/image108.png)

- `Input Delay Offset` - покадровая задержка входящего видео потока
- `Tracking Delay` - покадровая задержка данных из трекинг системы
- `Apply` - применить изменения
- `Стрелка` - служит для сброса `output delay` в `Carrot Engine`.
